<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ЛИНИИ РАЗУМА</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      h1 {
        font-size: 48px;
        font-weight: bold;
        color: #fff;
        margin-bottom: 10px;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        letter-spacing: 4px;
      }
      #level-info {
        font-size: 18px;
        margin-bottom: 20px;
        color: #fff;
        font-weight: 500;
      }
      #game-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 520px;
      }
      #game-canvas {
        border: 2px solid #333;
        cursor: crosshair;
        touch-action: none;
        width: 100%;
        height: auto;
        max-width: 490px;
      }
      #controls {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
      }
      button {
        padding: 12px 20px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        color: white;
        transition: all 0.3s;
        font-weight: 500;
        width: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .menu-toggle-button {
        position: fixed;
        top: 16px;
        left: 16px;
        width: 52px;
        height: 52px;
        padding: 0;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.18);
        color: #ffffff;
        font-size: 26px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(12px);
        border: 2px solid rgba(255, 255, 255, 0.35);
        z-index: 850;
      }
      .menu-toggle-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 14px 32px rgba(0, 0, 0, 0.3);
      }
      .menu-toggle-button:active {
        transform: translateY(0);
      }
      .hidden {
        display: none !important;
      }
      .start-menu-overlay {
        position: fixed;
        inset: 0;
        background: rgba(14, 24, 64, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 900;
      }
      .menu-panel {
        width: 100%;
        max-width: 360px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        padding: 28px 24px;
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(14px);
        display: flex;
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      .menu-panel h2 {
        margin: 0 0 8px;
        font-size: 24px;
        letter-spacing: 1px;
        color: #fff;
      }
      .menu-panel p {
        margin: 0;
        font-size: 15px;
        color: rgba(255, 255, 255, 0.85);
      }
      .menu-button {
        width: 100%;
      }
      .menu-button.primary {
        background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
      }
      .menu-button.secondary {
        background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
      }
      .menu-button.accent {
        background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%);
      }
      .menu-button.info {
        background: linear-gradient(135deg, #26c6da 0%, #00acc1 100%);
      }
      .menu-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
      }
      .info-button {
        background: linear-gradient(135deg, #26c6da 0%, #00acc1 100%);
      }
      .info-button:hover {
        background: linear-gradient(135deg, #00acc1 0%, #0097a7 100%);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transform: translateY(-2px);
      }
      .menu-note {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.75);
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 1000;
      }
      .modal-content {
        width: 100%;
        max-width: 420px;
        background: #ffffff;
        border-radius: 16px;
        padding: 28px 24px;
        color: #333;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .modal-content h3 {
        margin: 0;
        color: #4a4a4a;
        font-size: 22px;
        text-align: center;
      }
      .modal-content p {
        margin: 0;
        font-size: 16px;
        line-height: 1.5;
      }
      .modal-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
      }
      .modal button {
        flex: 1 1 120px;
        width: auto;
      }
      .modal button.confirm-action {
        background: linear-gradient(135deg, #ef5350 0%, #d32f2f 100%);
      }
      .modal button.secondary-action {
        background: linear-gradient(135deg, #b0bec5 0%, #90a4ae 100%);
      }
      .rules-list {
        font-size: 15px;
        line-height: 1.6;
        color: #333;
        padding-left: 18px;
      }
      .rules-list li {
        margin-bottom: 6px;
      }
      .level-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(56px, 1fr));
        gap: 10px;
        max-height: 320px;
        overflow-y: auto;
        padding-right: 4px;
      }
      .level-tile {
        padding: 10px 0;
        background: linear-gradient(135deg, #5c6bc0 0%, #3949ab 100%);
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .level-tile:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(60, 72, 182, 0.35);
      }
      .level-tile:disabled {
        background: #b0bec5;
        color: rgba(255, 255, 255, 0.8);
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }
      #undo-btn {
        background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
      }
      #undo-btn:hover {
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transform: translateY(-2px);
      }
      #clear-btn {
        background: linear-gradient(135deg, #ec407a 0%, #e91e63 100%);
      }
      #clear-btn:hover {
        background: linear-gradient(135deg, #e91e63 0%, #d81b60 100%);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transform: translateY(-2px);
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }
      #message {
        margin-top: 15px;
        font-size: 18px;
        font-weight: bold;
        color: #4caf50;
        min-height: 25px;
      }
      .inline-rules {
        margin-top: 24px;
        padding: 18px 20px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 14px;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.12);
        color: #333;
        width: 100%;
        text-align: left;
      }
      .inline-rules h3 {
        margin: 0 0 12px;
        font-size: 18px;
        color: #3949ab;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .inline-rules .rules-list {
        padding-left: 20px;
        margin: 0;
      }
      .inline-rules .rules-list li {
        margin-bottom: 8px;
        line-height: 1.6;
      }
      .inline-rules .control-tip {
        margin-top: 14px;
        font-size: 15px;
        line-height: 1.5;
      }
      @media (max-width: 600px) {
        body {
          padding: 16px 12px 32px;
        }
        h1 {
          font-size: 34px;
          letter-spacing: 2px;
          text-align: center;
        }
        #level-info {
          font-size: 16px;
          text-align: center;
        }
        #game-container {
          padding: 16px;
        }
        button {
          font-size: 15px;
        }
        .menu-panel {
          max-width: 320px;
          padding: 24px 20px;
        }
        .modal-content {
          padding: 24px 20px;
        }
        .level-grid {
          max-height: 260px;
        }
        .menu-toggle-button {
          top: 12px;
          left: 12px;
          width: 44px;
          height: 44px;
          font-size: 22px;
        }
        .inline-rules {
          padding: 16px;
        }
      }
    </style>
  </head>
  <body>
    <button
      id="menu-toggle"
      class="menu-toggle-button hidden"
      type="button"
      aria-label="Открыть главное меню"
    >
      &#9776;
    </button>
    <div id="start-menu" class="start-menu-overlay">
      <div class="menu-panel">
        <h2>Стартовое меню</h2>
        <p>Выберите действие, чтобы продолжить игру.</p>
        <button id="continue-btn" class="menu-button primary">
          Продолжить игру
        </button>
        <div class="menu-note" id="continue-level-label">
          Доступный уровень: 1
        </div>
        <button id="new-game-btn" class="menu-button secondary">Новая игра</button>
        <button id="select-level-btn" class="menu-button accent">
          Выбрать уровень
        </button>
        <button id="rules-btn" class="menu-button info">Правила игры</button>
      </div>
    </div>

    <div id="new-game-modal" class="modal hidden" role="dialog" aria-modal="true">
      <div class="modal-content">
        <h3>Новая игра</h3>
        <p>
          При запуске игры заново, сохранение вашего игрового процесса будет
          потеряно. Вы уверены, что хотите начать новую игру?
        </p>
        <div class="modal-buttons">
          <button id="confirm-new-game" class="confirm-action">Да</button>
          <button id="cancel-new-game" class="secondary-action">Нет</button>
        </div>
      </div>
    </div>

    <div id="rules-modal" class="modal hidden" role="dialog" aria-modal="true">
      <div class="modal-content">
        <h3>Правила игры</h3>
        <ul class="rules-list">
          <li>Начните с клетки с цифрой <strong>1</strong>.</li>
          <li>
            Проведите линию последовательно через цифры
            <strong>1→2→3→...→9</strong>.
          </li>
          <li>
            Линия должна заполнить <strong>все 49 клеток</strong> игрового поля.
          </li>
          <li>
            Переходите только на <strong>соседние клетки</strong> (вверх, вниз,
            влево, вправо).
          </li>
          <li>Нельзя проходить дважды через одну клетку.</li>
        </ul>
        <p>
          <strong>💡 Управление:</strong> Рисуйте линию мышью или пальцем,
          удерживая кнопку нажатой. Красная линия означает ошибку!
        </p>
        <div class="modal-buttons">
          <button id="close-rules-btn" class="secondary-action">Закрыть</button>
        </div>
      </div>
    </div>

    <div id="level-modal" class="modal hidden" role="dialog" aria-modal="true">
      <div class="modal-content">
        <h3>Выбор уровня</h3>
        <div class="menu-note">
          Доступны уровни от 1 до текущего открытого уровня.
        </div>
        <div id="level-grid" class="level-grid"></div>
        <div class="modal-buttons">
          <button id="close-levels-btn" class="secondary-action">Закрыть</button>
        </div>
      </div>
    </div>

    <h1>ЛИНИИ РАЗУМА</h1>
    <div id="level-info">Уровень: <span id="current-level">1</span></div>
    <div id="game-container">
      <canvas id="game-canvas" width="490" height="490"></canvas>
      <div id="controls">
        <button id="undo-btn">Отменить последнее действие</button>
        <button id="clear-btn">Очистить поле</button>
      </div>
      <div id="message"></div>
      <section id="inline-rules" class="inline-rules">
        <h3>Правила игры</h3>
        <ul class="rules-list">
          <li>Начните с клетки с цифрой <strong>1</strong>.</li>
          <li>
            Проведите линию последовательно через цифры
            <strong>1→2→3→...9</strong>.
          </li>
          <li>
            Линия должна заполнить <strong>все 49 клеток</strong> игрового поля.
          </li>
          <li>
            Переходите только на <strong>соседние клетки</strong> (вверх, вниз,
            влево, вправо).
          </li>
          <li>Нельзя проходить дважды через одну клетку.</li>
        </ul>
        <p class="control-tip">
          <strong>💡 Управление:</strong> Рисуйте линию мышью или пальцем,
          удерживая кнопку нажатой. Красная линия означает ошибку!
        </p>
      </section>
    </div>

    <script>
      // Проверка загрузки скрипта
      console.log("✓ Скрипт игры начал выполнение");

      // Данные уровней (100 уровней)
      const gameDataJSON = [
        {
          round_id: 1,
          grid: [
            [1, null, null, null, null, null, 2],
            [null, 4, null, 3, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 9, 8, 7, null, 6],
            [null, null, null, null, null, null, null],
            [null, null, 5, null, null, null, null],
          ],
        },
        {
          round_id: 2,
          grid: [
            [1, null, null, null, null, null, null],
            [null, null, null, null, 8, null, 6],
            [null, null, null, 9, null, 7, null],
            [null, null, null, 5, null, null, null],
            [null, null, null, null, 3, null, 4],
            [null, null, null, null, null, null, 2],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 3,
          grid: [
            [1, null, null, null, null, null, 2],
            [null, null, null, null, null, 6, null],
            [null, null, 7, null, null, null, 3],
            [null, null, null, null, null, 8, null],
            [null, null, null, null, null, null, null],
            [null, 9, null, null, null, null, null],
            [5, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 4,
          grid: [
            [null, 8, null, 7, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 6, null, 5, null],
            [null, null, null, null, null, null, 4],
            [null, 9, null, 3, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 2, null, 1, null, null],
          ],
        },
        {
          round_id: 5,
          grid: [
            [null, null, null, null, null, null, null],
            [5, null, null, null, null, 4, null],
            [null, null, null, 8, 3, null, null],
            [null, null, null, null, null, null, 2],
            [null, null, null, 9, 1, null, null],
            [null, null, null, 7, null, null, null],
            [null, 6, null, null, null, null, null],
          ],
        },
        {
          round_id: 6,
          grid: [
            [null, 6, null, null, null, null, null],
            [null, null, 7, 8, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [5, null, null, 9, null, 3, null],
            [4, null, null, null, null, null, 2],
            [null, null, null, null, null, null, 1],
          ],
        },
        {
          round_id: 7,
          grid: [
            [null, null, null, null, null, null, null],
            [9, null, null, null, null, 8, 7],
            [1, null, null, null, 6, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 5, null, null, null, null],
            [null, 4, null, null, null, null, null],
            [null, null, 2, 3, null, null, null],
          ],
        },
        {
          round_id: 8,
          grid: [
            [null, null, 9, null, null, null, null],
            [null, null, 8, null, null, null, null],
            [null, null, null, 7, null, null, null],
            [null, null, null, null, null, 3, null],
            [null, 6, null, null, null, null, null],
            [4, null, null, null, 5, null, 2],
            [null, null, null, null, null, null, 1],
          ],
        },
        {
          round_id: 9,
          grid: [
            [null, null, 3, 2, null, null, null],
            [4, null, null, null, null, null, null],
            [null, null, 6, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [null, null, null, null, null, null, 1],
            [5, null, null, 7, null, null, null],
            [null, null, null, null, null, 9, null],
          ],
        },
        {
          round_id: 10,
          grid: [
            [null, null, null, null, 3, null, null],
            [2, 8, 7, null, null, null, null],
            [1, null, null, null, null, null, null],
            [null, null, null, null, null, 6, null],
            [null, null, 9, null, null, null, null],
            [5, null, null, null, null, null, 4],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 11,
          grid: [
            [null, null, null, null, null, 4, null],
            [null, null, 6, null, null, null, null],
            [null, null, null, 7, null, null, null],
            [3, null, null, null, 8, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 2, null, 9, null, null],
            [null, null, 1, null, null, 5, null],
          ],
        },
        {
          round_id: 12,
          grid: [
            [null, null, 1, null, null, null, 8],
            [null, 7, null, null, null, 9, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 5, null, 6, null, null],
            [null, null, null, null, 4, null, null],
            [null, null, 2, null, 3, null, null],
          ],
        },
        {
          round_id: 13,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, 8, null, null, null],
            [null, null, null, null, null, null, 7],
            [null, null, null, null, null, 1, null],
            [9, null, null, null, 6, null, null],
            [null, null, null, 4, null, 5, null],
            [null, null, 3, null, 2, null, null],
          ],
        },
        {
          round_id: 14,
          grid: [
            [null, null, null, null, null, 2, null],
            [null, null, null, null, 7, null, null],
            [1, null, null, null, null, null, null],
            [5, null, null, null, null, null, 3],
            [null, null, 6, null, 9, null, null],
            [null, null, null, null, null, 8, null],
            [null, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 15,
          grid: [
            [null, null, 8, null, null, null, null],
            [null, 2, null, null, null, null, null],
            [null, null, null, null, 7, null, null],
            [null, null, null, null, null, 5, null],
            [null, null, null, null, 6, null, null],
            [null, null, null, 9, null, null, null],
            [1, null, 3, null, 4, null, null],
          ],
        },
        {
          round_id: 16,
          grid: [
            [1, null, null, null, null, null, 5],
            [null, 4, null, 9, null, null, 6],
            [null, null, null, null, null, 7, null],
            [null, null, 8, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 3, null],
            [null, null, 2, null, null, null, null],
          ],
        },
        {
          round_id: 17,
          grid: [
            [null, null, null, null, null, 3, 4],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [2, null, null, 7, null, 6, null],
            [null, 8, null, null, 1, 5, null],
            [null, 9, null, null, null, null, null],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 18,
          grid: [
            [2, null, null, null, null, null, null],
            [null, null, null, 7, null, null, null],
            [3, 6, null, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [null, 5, null, null, null, null, 1],
            [null, null, null, null, null, null, null],
            [null, 4, null, null, 9, null, null],
          ],
        },
        {
          round_id: 19,
          grid: [
            [null, null, null, null, 9, null, null],
            [3, null, null, null, null, null, null],
            [null, null, null, null, 5, null, 8],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [2, 1, 4, null, 6, null, null],
            [null, null, null, null, null, null, 7],
          ],
        },
        {
          round_id: 20,
          grid: [
            [null, null, null, null, null, 6, 7],
            [null, null, null, null, null, null, null],
            [null, null, null, 9, null, null, 1],
            [null, null, null, null, null, 8, null],
            [5, null, null, 4, null, null, null],
            [null, null, null, null, 3, null, null],
            [null, 2, null, null, null, null, null],
          ],
        },
        {
          round_id: 21,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, 8],
            [null, 4, 9, null, null, null, null],
            [null, null, null, 5, 6, 7, null],
            [3, null, null, null, null, null, null],
            [null, null, null, null, 2, null, null],
            [null, null, null, null, null, null, 1],
          ],
        },
        {
          round_id: 22,
          grid: [
            [3, null, null, null, null, 7, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [null, null, null, 9, null, null, 6],
            [2, 4, null, null, null, null, null],
            [null, 1, null, null, 5, null, null],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 23,
          grid: [
            [null, null, null, null, null, 3, null],
            [null, null, null, null, 4, 5, null],
            [null, null, 9, null, null, null, null],
            [null, null, 8, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 7, null, null, 1, null],
            [null, null, 6, null, null, 2, null],
          ],
        },
        {
          round_id: 24,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, null, 8, 1, null],
            [null, 6, null, null, null, null, null],
            [5, null, 7, null, null, null, 2],
            [null, null, null, 9, null, null, null],
            [null, null, null, null, null, null, null],
            [4, null, null, 3, null, null, null],
          ],
        },
        {
          round_id: 25,
          grid: [
            [3, null, null, null, null, null, 4],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, 9],
            [null, null, null, 8, null, null, null],
            [null, null, 7, null, null, null, 1],
            [null, null, null, 5, null, 6, null],
            [2, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 26,
          grid: [
            [null, null, null, null, null, null, 8],
            [null, 6, null, null, null, null, 9],
            [null, null, null, null, 7, null, null],
            [null, 5, null, null, null, null, null],
            [null, null, null, null, 4, null, null],
            [null, null, null, null, null, null, null],
            [3, null, 2, null, 1, null, null],
          ],
        },
        {
          round_id: 27,
          grid: [
            [3, 2, null, null, 7, null, null],
            [null, null, null, 1, null, null, 6],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, 8, null, null, 9, null, null],
            [4, null, null, 5, null, null, null],
          ],
        },
        {
          round_id: 28,
          grid: [
            [null, null, null, 7, null, null, null],
            [null, null, null, null, null, 3, null],
            [null, null, null, null, null, null, null],
            [null, null, 9, null, null, null, 2],
            [6, null, null, 8, null, 4, null],
            [5, null, null, null, null, null, null],
            [null, null, null, null, null, null, 1],
          ],
        },
        {
          round_id: 29,
          grid: [
            [null, null, null, null, 9, null, null],
            [null, 1, null, null, null, null, null],
            [2, null, null, null, 8, null, null],
            [null, null, null, null, null, 7, null],
            [3, null, null, 5, 6, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 30,
          grid: [
            [null, null, 6, null, null, null, null],
            [null, 7, null, 8, null, null, 3],
            [null, null, null, null, 5, null, null],
            [null, null, 9, null, null, null, null],
            [null, null, null, null, 4, null, null],
            [null, 1, null, null, null, null, null],
            [null, null, 2, null, null, null, null],
          ],
        },
        {
          round_id: 31,
          grid: [
            [5, null, null, null, null, 3, null],
            [null, null, null, null, null, null, null],
            [6, null, 9, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 4, null, null],
            [null, 8, null, null, null, null, null],
            [null, 7, null, null, 1, null, 2],
          ],
        },
        {
          round_id: 32,
          grid: [
            [null, null, null, 2, 3, 4, null],
            [null, 1, null, 5, null, null, null],
            [null, null, null, null, null, 6, null],
            [null, null, null, null, null, null, null],
            [null, 8, null, null, null, null, null],
            [null, null, null, null, null, 9, null],
            [7, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 33,
          grid: [
            [null, null, 9, null, null, 7, 6],
            [null, null, null, null, null, null, null],
            [null, null, 2, null, null, null, null],
            [null, null, 3, null, null, 8, 5],
            [null, null, null, null, null, null, null],
            [null, 1, null, null, null, null, null],
            [null, null, null, null, null, 4, null],
          ],
        },
        {
          round_id: 34,
          grid: [
            [6, null, null, null, null, 5, 1],
            [null, null, null, null, null, null, null],
            [null, null, 9, null, 8, null, null],
            [null, null, null, null, null, null, null],
            [null, 7, null, null, null, null, null],
            [null, null, 3, null, null, 4, null],
            [null, null, 2, null, null, null, null],
          ],
        },
        {
          round_id: 35,
          grid: [
            [null, null, null, null, null, null, 3],
            [2, null, 8, 9, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 7, null],
            [null, 6, null, null, null, null, null],
            [null, null, null, 5, null, null, 4],
            [null, null, null, null, 1, null, null],
          ],
        },
        {
          round_id: 36,
          grid: [
            [null, null, 6, null, null, null, null],
            [null, 1, null, null, null, 7, null],
            [null, 2, null, null, 8, null, null],
            [3, null, null, null, null, null, null],
            [null, null, null, null, null, null, 5],
            [null, null, 9, null, null, null, null],
            [null, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 37,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, null, 3, null, null],
            [null, null, 8, null, null, 4, 2],
            [null, null, null, 7, 5, 1, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 6, null, null, null],
            [null, 9, null, null, null, null, null],
          ],
        },
        {
          round_id: 38,
          grid: [
            [null, null, 3, null, null, null, 2],
            [null, 4, null, null, null, 1, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 9, null, null, null],
            [8, null, null, null, null, null, 5],
            [null, null, null, null, null, null, null],
            [7, null, null, null, null, null, 6],
          ],
        },
        {
          round_id: 39,
          grid: [
            [null, null, 1, null, 2, null, null],
            [null, 6, null, null, null, null, null],
            [5, null, 8, null, 9, null, null],
            [null, null, null, null, null, null, null],
            [4, null, null, null, null, null, null],
            [null, null, null, null, null, 7, null],
            [null, null, null, null, 3, null, null],
          ],
        },
        {
          round_id: 40,
          grid: [
            [1, null, null, null, null, null, null],
            [null, null, null, 9, null, null, null],
            [null, 7, null, null, 8, null, null],
            [2, null, null, null, 6, null, 4],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 5, null],
            [null, 3, null, null, null, null, null],
          ],
        },
        {
          round_id: 41,
          grid: [
            [null, 2, null, null, 3, null, null],
            [null, 1, 4, null, null, null, null],
            [null, null, null, 6, null, null, null],
            [null, null, null, 5, null, null, 9],
            [null, null, null, null, null, null, null],
            [null, null, null, 8, null, null, null],
            [7, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 42,
          grid: [
            [9, null, null, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 5, 6, 7, null],
            [null, null, null, null, null, null, 1],
            [null, null, 4, null, null, 3, null],
            [null, null, null, null, null, 2, null],
          ],
        },
        {
          round_id: 43,
          grid: [
            [null, null, 1, null, null, null, null],
            [null, null, 4, null, null, 3, null],
            [null, null, 6, null, null, null, null],
            [null, null, null, null, 9, null, null],
            [null, null, null, null, 8, null, null],
            [null, null, null, null, null, null, null],
            [null, 5, null, 7, null, null, 2],
          ],
        },
        {
          round_id: 44,
          grid: [
            [null, null, null, null, 4, null, 5],
            [3, null, null, null, null, null, null],
            [null, null, 1, null, null, null, null],
            [null, null, null, 7, 8, 9, null],
            [null, null, null, null, null, null, null],
            [2, null, null, null, null, null, null],
            [null, null, null, null, 6, null, null],
          ],
        },
        {
          round_id: 45,
          grid: [
            [null, null, null, null, null, null, null],
            [2, null, null, null, null, null, 9],
            [null, null, null, 5, null, null, null],
            [null, null, null, null, null, 8, null],
            [null, null, 4, null, 7, null, null],
            [null, 3, null, null, null, null, null],
            [1, null, null, null, null, null, 6],
          ],
        },
        {
          round_id: 46,
          grid: [
            [null, null, 1, null, null, null, 2],
            [null, 9, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, 8, 6, 5, null, 3, null],
            [null, null, 7, null, null, null, null],
            [null, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 47,
          grid: [
            [null, null, 1, 2, null, null, null],
            [null, null, null, null, null, null, 3],
            [4, null, null, null, null, null, 5],
            [null, 7, null, null, 6, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 9, null, 8, null, null],
          ],
        },
        {
          round_id: 48,
          grid: [
            [null, null, null, null, null, 5, 1],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, 2],
            [null, null, null, null, 9, null, null],
            [null, null, null, null, null, null, 3],
            [null, 6, null, 7, null, 8, null],
            [null, 4, null, null, null, null, null],
          ],
        },
        {
          round_id: 49,
          grid: [
            [null, null, 9, null, null, null, null],
            [null, null, 8, null, null, null, 7],
            [1, 6, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 5, null, null],
            [2, null, null, null, null, null, 4],
            [null, null, null, 3, null, null, null],
          ],
        },
        {
          round_id: 50,
          grid: [
            [null, null, null, null, null, 3, null],
            [2, null, null, null, null, null, null],
            [null, null, null, null, null, null, 4],
            [null, 6, null, null, null, null, null],
            [1, null, null, 7, null, 5, null],
            [null, null, null, null, null, null, null],
            [9, null, null, null, 8, null, null],
          ],
        },
        {
          round_id: 51,
          grid: [
            [1, null, null, null, null, null, null],
            [null, 3, null, null, null, null, null],
            [null, null, null, null, null, 9, 4],
            [null, null, null, null, null, null, null],
            [2, null, 6, null, 8, null, null],
            [null, null, null, null, 7, null, null],
            [null, null, null, null, 5, null, null],
          ],
        },
        {
          round_id: 52,
          grid: [
            [null, 2, null, null, null, null, 6],
            [null, null, null, null, null, 9, null],
            [null, null, null, null, null, null, null],
            [null, null, 7, null, null, null, null],
            [1, null, null, 8, null, null, null],
            [4, 3, null, null, null, null, 5],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 53,
          grid: [
            [null, null, null, null, 5, null, null],
            [null, 1, null, 3, null, null, null],
            [2, null, null, null, 4, null, null],
            [7, null, 6, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 8, null, null, null],
            [null, null, null, null, null, null, 9],
          ],
        },
        {
          round_id: 54,
          grid: [
            [null, null, 1, 7, null, null, null],
            [null, null, null, 6, null, null, null],
            [2, 3, null, null, null, null, null],
            [null, null, null, null, null, 9, null],
            [null, null, null, null, null, null, null],
            [null, null, 4, 5, null, null, null],
            [null, null, null, null, null, null, 8],
          ],
        },
        {
          round_id: 55,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, 9, null, null, 8, null],
            [6, null, null, 7, null, null, null],
            [null, null, null, null, null, 5, null],
            [null, null, null, 4, null, null, null],
            [null, 1, 2, null, null, null, null],
            [null, null, null, null, 3, null, null],
          ],
        },
        {
          round_id: 56,
          grid: [
            [4, null, null, 5, null, null, null],
            [null, null, null, null, null, 7, null],
            [null, null, null, null, 8, 6, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [3, null, 9, null, null, 1, null],
            [2, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 57,
          grid: [
            [5, null, null, null, null, null, null],
            [null, null, null, null, null, 2, null],
            [null, null, null, null, 1, null, null],
            [null, null, null, 4, null, null, null],
            [6, null, null, null, null, 3, null],
            [null, null, null, null, 8, null, null],
            [null, null, 7, null, 9, null, null],
          ],
        },
        {
          round_id: 58,
          grid: [
            [1, null, null, null, null, null, null],
            [null, null, null, 6, null, null, null],
            [null, null, 7, null, null, null, null],
            [null, null, null, null, null, null, null],
            [8, null, null, null, null, null, null],
            [null, null, null, 5, null, 3, null],
            [9, null, null, null, 4, null, 2],
          ],
        },
        {
          round_id: 59,
          grid: [
            [null, null, null, null, 2, null, 3],
            [null, 1, null, null, null, null, null],
            [null, null, null, null, 6, null, null],
            [null, null, null, null, null, 9, null],
            [4, null, null, null, null, null, null],
            [null, null, null, null, null, 8, null],
            [null, null, 5, null, 7, null, null],
          ],
        },
        {
          round_id: 60,
          grid: [
            [null, 3, null, null, null, null, null],
            [null, null, null, null, null, null, 4],
            [null, null, null, null, 5, null, null],
            [null, 6, null, null, null, null, null],
            [null, null, null, null, null, null, 7],
            [2, null, null, 9, null, 8, null],
            [1, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 61,
          grid: [
            [5, null, null, null, 4, null, null],
            [null, 6, null, null, null, null, null],
            [null, null, null, null, null, null, 3],
            [9, null, 8, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 7, null, null, null, null],
            [null, null, null, null, 1, null, 2],
          ],
        },
        {
          round_id: 62,
          grid: [
            [null, null, null, 9, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [6, 7, null, null, 8, 4, 3],
            [null, null, null, null, null, null, null],
            [null, null, null, 5, null, null, null],
            [1, null, null, null, 2, null, null],
          ],
        },
        {
          round_id: 63,
          grid: [
            [3, null, null, null, null, 2, null],
            [null, null, null, null, null, 1, null],
            [null, null, 4, null, null, 7, null],
            [5, null, null, 8, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 9, null, null, null],
            [null, null, null, null, null, 6, null],
          ],
        },
        {
          round_id: 64,
          grid: [
            [null, null, 4, null, null, null, null],
            [null, null, null, 3, null, null, null],
            [null, null, null, null, null, null, 2],
            [null, 5, null, null, null, null, null],
            [null, null, null, null, 1, null, null],
            [6, null, null, null, null, 9, null],
            [null, null, null, 7, null, 8, null],
          ],
        },
        {
          round_id: 65,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, 8, null, null, null, null],
            [null, null, 9, null, null, null, 3],
            [null, null, null, null, null, null, 2],
            [7, 6, null, null, null, null, null],
            [null, null, null, null, 4, 1, null],
            [5, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 66,
          grid: [
            [null, null, null, null, 2, null, null],
            [null, 1, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [3, 6, null, 5, null, null, null],
            [null, null, 8, null, null, null, null],
            [null, 7, null, null, null, 9, null],
            [null, 4, null, null, null, null, null],
          ],
        },
        {
          round_id: 67,
          grid: [
            [null, null, null, null, 4, null, null],
            [null, 2, null, null, null, null, null],
            [null, null, null, null, 5, null, null],
            [null, null, 3, null, null, 6, null],
            [1, null, null, null, 7, null, null],
            [null, null, null, null, null, 8, null],
            [null, null, 9, null, null, null, null],
          ],
        },
        {
          round_id: 68,
          grid: [
            [null, 7, null, null, null, null, null],
            [null, null, 9, null, null, 1, null],
            [null, null, null, null, null, 2, null],
            [null, null, null, null, 3, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 8, null, null, null],
            [6, null, null, 5, 4, null, null],
          ],
        },
        {
          round_id: 69,
          grid: [
            [null, null, 2, null, 1, null, null],
            [null, 7, null, null, null, null, null],
            [null, null, null, null, null, null, 6],
            [null, 8, null, null, null, 9, null],
            [3, null, 5, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 70,
          grid: [
            [null, null, null, 2, null, null, 3],
            [null, null, null, null, null, null, null],
            [9, null, 1, null, null, null, null],
            [null, null, null, 5, null, null, null],
            [null, null, null, 6, null, null, null],
            [null, null, null, null, null, 4, null],
            [8, null, null, null, 7, null, null],
          ],
        },
        {
          round_id: 71,
          grid: [
            [null, null, null, null, null, null, null],
            [2, null, null, null, 9, null, null],
            [null, null, 6, 8, null, null, 7],
            [null, null, 5, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 4, null, null],
            [1, 3, null, null, null, null, null],
          ],
        },
        {
          round_id: 72,
          grid: [
            [2, null, null, null, null, null, null],
            [null, null, null, null, null, 3, null],
            [null, null, null, 4, null, null, null],
            [null, null, 7, null, 6, null, null],
            [null, null, null, 8, null, null, 5],
            [null, 1, null, null, null, null, null],
            [null, null, null, 9, null, null, null],
          ],
        },
        {
          round_id: 73,
          grid: [
            [9, null, null, null, 1, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 7, 8, null, null],
            [null, 6, null, null, null, null, null],
            [null, null, null, 3, 4, 5, 2],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 74,
          grid: [
            [null, null, null, null, null, null, null],
            [3, null, 8, null, null, null, 9],
            [null, null, null, null, null, null, null],
            [null, 4, null, null, null, null, null],
            [null, null, null, null, null, null, 7],
            [null, 1, null, null, 6, null, null],
            [2, null, null, null, null, 5, null],
          ],
        },
        {
          round_id: 75,
          grid: [
            [null, null, 6, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 5, null, 4, null, 7],
            [null, null, null, null, null, null, null],
            [3, null, null, null, 2, null, 8],
            [null, null, null, null, null, 9, null],
            [null, null, 1, null, null, null, null],
          ],
        },
        {
          round_id: 76,
          grid: [
            [null, 4, null, null, 3, 2, null],
            [null, null, null, 8, null, null, null],
            [null, null, null, null, null, null, null],
            [null, 9, null, null, null, null, null],
            [null, null, null, null, 1, null, null],
            [null, null, null, 7, null, null, null],
            [null, 5, null, null, 6, null, null],
          ],
        },
        {
          round_id: 77,
          grid: [
            [9, null, null, null, 5, null, null],
            [null, null, null, null, 4, null, 2],
            [null, null, null, null, 3, null, null],
            [null, null, null, null, null, null, null],
            [null, 8, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [7, null, null, 6, 1, null, null],
          ],
        },
        {
          round_id: 78,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 5, 2],
            [3, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 6, 1],
            [null, 4, null, 8, 9, null, null],
            [null, null, null, 7, null, null, null],
          ],
        },
        {
          round_id: 79,
          grid: [
            [null, null, 9, null, null, null, null],
            [null, null, null, null, null, null, null],
            [5, null, null, null, null, 8, 7],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 3, 2, null],
            [null, null, 6, null, null, 1, null],
            [null, 4, null, null, null, null, null],
          ],
        },
        {
          round_id: 80,
          grid: [
            [3, 4, null, null, 9, null, null],
            [null, 5, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 6, 7, null, 1, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [null, null, null, 2, null, null, null],
          ],
        },
        {
          round_id: 81,
          grid: [
            [null, 2, null, null, null, null, null],
            [null, null, null, null, null, null, 4],
            [null, null, null, 6, 7, null, null],
            [null, null, null, null, 8, 9, null],
            [null, null, 5, null, null, null, null],
            [null, null, null, null, null, null, null],
            [1, null, null, null, null, null, 3],
          ],
        },
        {
          round_id: 82,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, 9, null, null, 6, null, 7],
            [null, null, null, null, null, 1, null],
            [null, 8, null, null, null, null, null],
            [null, 3, null, 4, null, 5, null],
            [null, null, null, null, null, null, 2],
          ],
        },
        {
          round_id: 83,
          grid: [
            [null, 9, null, null, 4, null, null],
            [8, null, null, null, null, null, null],
            [null, null, 3, null, null, null, null],
            [7, null, null, null, null, null, null],
            [null, null, 1, null, 2, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 6, null, 5, null],
          ],
        },
        {
          round_id: 84,
          grid: [
            [null, null, null, 5, null, null, null],
            [4, null, null, null, 6, null, null],
            [null, null, null, 7, null, null, null],
            [null, null, null, null, null, null, 8],
            [null, null, 9, null, 1, 2, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 3, null, null],
          ],
        },
        {
          round_id: 85,
          grid: [
            [null, null, 4, null, null, null, 1],
            [null, null, null, null, null, 3, null],
            [null, null, 7, null, null, null, null],
            [null, null, null, 9, null, null, null],
            [null, 6, null, null, null, null, null],
            [5, null, null, null, null, null, 2],
            [null, null, null, 8, null, null, null],
          ],
        },
        {
          round_id: 86,
          grid: [
            [null, null, null, null, null, null, null],
            [8, null, null, null, null, null, 6],
            [null, null, null, null, 7, null, null],
            [null, null, null, 9, null, null, null],
            [1, null, null, null, null, null, null],
            [2, null, null, null, null, null, null],
            [null, null, 3, 4, 5, null, null],
          ],
        },
        {
          round_id: 87,
          grid: [
            [5, null, null, null, null, null, null],
            [null, null, null, null, null, 6, null],
            [1, null, null, null, null, 8, null],
            [null, null, 7, null, null, null, null],
            [null, 4, null, null, null, 9, null],
            [null, null, null, null, null, null, 3],
            [null, null, 2, null, null, null, null],
          ],
        },
        {
          round_id: 88,
          grid: [
            [null, null, null, null, 1, null, 2],
            [null, 7, null, null, null, null, null],
            [8, null, null, null, 3, null, 4],
            [null, null, null, 6, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [9, null, null, null, null, null, 5],
          ],
        },
        {
          round_id: 89,
          grid: [
            [null, null, null, null, 7, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 2, null, null],
            [null, 8, null, 1, null, 6, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 5, null],
            [null, null, 9, null, 3, null, 4],
          ],
        },
        {
          round_id: 90,
          grid: [
            [null, null, null, null, null, null, null],
            [null, 1, null, 3, null, null, 2],
            [null, null, null, null, null, null, null],
            [null, 9, null, null, null, null, 4],
            [null, null, null, 8, null, null, null],
            [null, 7, null, null, null, null, null],
            [null, null, 6, null, null, null, 5],
          ],
        },
        {
          round_id: 91,
          grid: [
            [null, 4, null, null, null, null, null],
            [3, null, null, null, null, null, 7],
            [null, null, null, 9, 8, null, null],
            [2, null, null, null, null, null, null],
            [null, null, 5, null, null, null, null],
            [null, 1, null, null, null, null, null],
            [null, null, 6, null, null, null, null],
          ],
        },
        {
          round_id: 92,
          grid: [
            [null, null, 4, 5, null, null, null],
            [null, null, null, null, null, 8, 7],
            [null, 3, null, null, null, null, null],
            [null, 2, null, null, null, null, null],
            [null, null, null, null, null, 9, null],
            [null, null, null, null, 6, null, null],
            [null, null, 1, null, null, null, null],
          ],
        },
        {
          round_id: 93,
          grid: [
            [null, null, null, null, null, 6, null],
            [null, 2, null, null, null, null, null],
            [null, null, null, null, null, null, 7],
            [null, 1, 3, 5, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 4, null, null, null, 8],
            [null, null, null, null, null, null, 9],
          ],
        },
        {
          round_id: 94,
          grid: [
            [null, null, null, null, null, null, 9],
            [null, 1, null, null, null, null, null],
            [null, 2, null, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [3, 6, null, null, null, null, 7],
            [null, null, null, null, null, null, null],
            [null, 4, null, null, null, null, 5],
          ],
        },
        {
          round_id: 95,
          grid: [
            [4, null, null, null, null, 5, null],
            [null, 3, null, null, null, null, null],
            [2, null, null, null, null, 8, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 9, null, 7, 6],
            [null, 1, null, null, null, null, null],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 96,
          grid: [
            [null, null, null, 3, null, null, null],
            [null, 5, null, null, 2, 1, null],
            [null, null, null, 4, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 7, null, null, null, null],
            [6, null, null, null, null, 9, null],
            [null, null, 8, null, null, null, null],
          ],
        },
        {
          round_id: 97,
          grid: [
            [null, null, null, null, 3, 4, 5],
            [null, null, 8, 7, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 2, 9, null, null, null],
            [null, 1, null, null, null, 6, null],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 98,
          grid: [
            [null, null, 9, null, null, null, null],
            [null, null, null, null, null, 8, null],
            [1, 2, null, null, null, null, 7],
            [null, null, null, null, null, 6, null],
            [null, null, null, null, 3, null, null],
            [null, null, null, null, null, 5, null],
            [null, null, null, null, null, null, 4],
          ],
        },
        {
          round_id: 99,
          grid: [
            [6, null, null, 7, 8, null, null],
            [null, null, null, 9, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 5, null, null, null, null],
            [null, null, null, 3, 1, null, null],
            [null, null, null, null, null, null, 2],
            [null, null, 4, null, null, null, null],
          ],
        },
        {
          round_id: 100,
          grid: [
            [null, null, null, 6, null, null, null],
            [null, 9, 8, null, null, null, null],
            [null, null, null, null, null, null, 1],
            [null, null, null, null, null, null, null],
            [null, 7, null, null, null, 3, 2],
            [null, null, 5, null, null, null, null],
            [null, null, null, 4, null, null, null],
          ],
        },
      ];

      console.log(
        "✓ Данные уровней загружены:",
        gameDataJSON.length,
        "уровней"
      );

      const canvas = document.getElementById("game-canvas");
      const ctx = canvas.getContext("2d");
      const undoBtn = document.getElementById("undo-btn");
      const clearBtn = document.getElementById("clear-btn");
      const messageDiv = document.getElementById("message");
      const levelSpan = document.getElementById("current-level");
      const startMenu = document.getElementById("start-menu");
      const continueBtn = document.getElementById("continue-btn");
      const continueLevelLabel = document.getElementById("continue-level-label");
      const newGameBtn = document.getElementById("new-game-btn");
      const selectLevelBtn = document.getElementById("select-level-btn");
      const rulesBtn = document.getElementById("rules-btn");
      const newGameModal = document.getElementById("new-game-modal");
      const confirmNewGameBtn = document.getElementById("confirm-new-game");
      const cancelNewGameBtn = document.getElementById("cancel-new-game");
      const rulesModal = document.getElementById("rules-modal");
      const closeRulesBtn = document.getElementById("close-rules-btn");
      const levelModal = document.getElementById("level-modal");
      const closeLevelsBtn = document.getElementById("close-levels-btn");
      const levelGrid = document.getElementById("level-grid");
      const gameContainer = document.getElementById("game-container");
      const menuToggleBtn = document.getElementById("menu-toggle");
      const levelModalNote = levelModal
        ? levelModal.querySelector(".menu-note")
        : null;

      console.log("✓ DOM элементы получены");

      const GRID_SIZE = 7;
      const MAX_CANVAS_SIZE = 490;
      const MIN_CANVAS_SIZE = 280;
      const CANVAS_SIDE_PADDING = 40;
      let canvasDisplaySize = canvas.clientWidth || canvas.width;
      let cellSize = canvasDisplaySize / GRID_SIZE;
      const AD_FORMAT = "interstitial";
      const STORAGE_KEY = "lines_of_mind_level";

      let gameData = [];
      let currentRound = 0;
      let currentGrid = [];
      let path = [];
      let isDrawing = false;
      let numbers = [];
      let gameBlocked = false;
      let errorSegmentIndex = -1;
      let adCheckIntervalId = null;
      let maxUnlockedLevel = 1;
      let progressLoaded = false;
      let appInitialized = false;
      let initPromise = null;

      function computeCanvasDisplaySize() {
        const container = canvas.parentElement;
        let availableWidth = MAX_CANVAS_SIZE;

        if (container) {
          const styles = window.getComputedStyle(container);
          const paddingLeft = parseFloat(styles.paddingLeft || "0");
          const paddingRight = parseFloat(styles.paddingRight || "0");
          availableWidth =
            container.clientWidth - paddingLeft - paddingRight;
        }

        if (!Number.isFinite(availableWidth) || availableWidth <= 0) {
          availableWidth = MAX_CANVAS_SIZE;
        }

        const viewportWidth = Math.min(
          window.innerWidth || MAX_CANVAS_SIZE,
          document.documentElement.clientWidth || MAX_CANVAS_SIZE
        );
        const viewportLimit = viewportWidth - CANVAS_SIDE_PADDING / 2;
        if (Number.isFinite(viewportLimit) && viewportLimit > 0) {
          availableWidth = Math.min(availableWidth, viewportLimit);
        }

        const minWidth = Math.min(MIN_CANVAS_SIZE, availableWidth);
        const clampedWidth = Math.max(
          minWidth,
          Math.min(MAX_CANVAS_SIZE, availableWidth)
        );

        return Math.round(clampedWidth);
      }

      function applyCanvasSize(displaySize) {
        canvasDisplaySize = displaySize;
        const dpr = window.devicePixelRatio || 1;
        canvas.style.width = `${displaySize}px`;
        canvas.style.height = `${displaySize}px`;
        const pixelSize = Math.round(displaySize * dpr);
        if (canvas.width !== pixelSize || canvas.height !== pixelSize) {
          canvas.width = pixelSize;
          canvas.height = pixelSize;
        }
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
        cellSize = displaySize / GRID_SIZE;
      }

      function resizeCanvas({ redraw = true } = {}) {
        const displaySize = computeCanvasDisplaySize();
        applyCanvasSize(displaySize);
        if (redraw) {
          drawGrid();
        }
      }

      function isBridgeAvailable() {
        const available =
          typeof window !== "undefined" &&
          window.vkBridge &&
          typeof window.vkBridge.send === "function";
        console.log("VK Bridge доступен?", available);
        return available;
      }

      async function checkNativeAds() {
        if (!isBridgeAvailable()) {
          return;
        }

        try {
          await window.vkBridge.send("VKWebAppCheckNativeAds", {
            ad_format: AD_FORMAT,
          });
        } catch (error) {
          console.error("Не удалось выполнить VKWebAppCheckNativeAds", error);
        }
      }

      async function showInterstitialAd() {
        if (!isBridgeAvailable()) {
          return;
        }

        try {
          const response = await window.vkBridge.send("VKWebAppShowNativeAds", {
            ad_format: AD_FORMAT,
          });

          if (!response?.result) {
            console.warn("Показ interstitial-рекламы не удался", response);
          }
        } catch (error) {
          console.error("Ошибка при показе interstitial-рекламы", error);
        }
      }

      async function loadSavedLevel() {
        if (!isBridgeAvailable()) {
          console.log("⚠ VK Storage недоступен, начинаем с уровня 1");
          return 1;
        }

        try {
          const response = await Promise.race([
            window.vkBridge.send("VKWebAppStorageGet", {
              keys: [STORAGE_KEY],
            }),
            new Promise((_, reject) =>
              setTimeout(() => reject(new Error("Timeout")), 2000)
            ),
          ]);

          if (response.keys && response.keys.length > 0) {
            const savedLevel = parseInt(response.keys[0].value, 10);
            if (!isNaN(savedLevel) && savedLevel >= 1 && savedLevel <= 100) {
              console.log("Загружен сохранённый уровень:", savedLevel);
              return savedLevel;
            }
          }
        } catch (error) {
          console.error(
            "Ошибка при загрузке уровня из VK Storage (таймаут или ошибка):",
            error.message
          );
        }

        console.log("Начинаем с уровня 1 (сохранение не найдено или ошибка)");
        return 1;
      }

      async function saveCurrentLevel(level) {
        if (!isBridgeAvailable()) {
          console.log("⚠ VK Storage недоступен, уровень не сохранён");
          return;
        }

        try {
          await Promise.race([
            window.vkBridge.send("VKWebAppStorageSet", {
              key: STORAGE_KEY,
              value: level.toString(),
            }),
            new Promise((_, reject) =>
              setTimeout(() => reject(new Error("Timeout")), 2000)
            ),
          ]);
          console.log("Уровень сохранён:", level);
        } catch (error) {
          console.error(
            "Ошибка при сохранении уровня в VK Storage (таймаут или ошибка):",
            error.message
          );
        }
      }

      async function ensureProgressLoaded() {
        if (progressLoaded) {
          return maxUnlockedLevel;
        }

        console.log("→ Загрузка доступного уровня из VK Storage...");
        const savedLevel = await loadSavedLevel();
        maxUnlockedLevel = Math.min(savedLevel, gameDataJSON.length);
        progressLoaded = true;
        updateContinueButtonLabel();
        console.log("✓ Доступный уровень:", maxUnlockedLevel);
        return maxUnlockedLevel;
      }

      async function initAds() {
        if (!isBridgeAvailable()) {
          console.log("⚠ VK Bridge недоступен (это нормально для CodeSandbox)");
          return;
        }

        try {
          await Promise.race([
            window.vkBridge.send("VKWebAppInit"),
            new Promise((_, reject) =>
              setTimeout(() => reject(new Error("Timeout")), 2000)
            ),
          ]);
        } catch (error) {
          console.error(
            "VKWebAppInit завершился с ошибкой или таймаут:",
            error.message
          );
          return;
        }

        await checkNativeAds();

        if (adCheckIntervalId === null) {
          adCheckIntervalId = setInterval(checkNativeAds, 60_000);
        }
      }

      function loadGameData() {
        gameData = gameDataJSON;
        console.log("✓ Игровые данные загружены в память");
      }

      function updateLevelModalNote() {
        if (levelModalNote) {
          levelModalNote.textContent = `Доступны уровни от 1 до ${maxUnlockedLevel}.`;
        }
      }

      function updateContinueButtonLabel() {
        if (continueLevelLabel) {
          continueLevelLabel.textContent = `Доступный уровень: ${maxUnlockedLevel}`;
        }
        updateLevelModalNote();
      }

      function showModal(modalElement) {
        if (modalElement) {
          modalElement.classList.remove("hidden");
        }
      }

      function hideModal(modalElement) {
        if (modalElement) {
          modalElement.classList.add("hidden");
        }
      }

      function openStartMenu() {
        showModal(startMenu);
        isDrawing = false;
        if (menuToggleBtn) {
          menuToggleBtn.classList.add("hidden");
        }
      }

      function closeStartMenu() {
        hideModal(startMenu);
        if (menuToggleBtn) {
          menuToggleBtn.classList.remove("hidden");
        }
      }

      function renderLevelTiles() {
        if (!levelGrid) {
          return;
        }

        levelGrid.innerHTML = "";

        for (let level = 1; level <= gameDataJSON.length; level++) {
          const tileButton = document.createElement("button");
          tileButton.type = "button";
          tileButton.textContent = level.toString();
          tileButton.className = "level-tile";

          if (level > maxUnlockedLevel) {
            tileButton.disabled = true;
          } else {
            tileButton.addEventListener("click", async () => {
              hideModal(levelModal);
              await initGame();
              await startGame(level);
            });
          }

          levelGrid.appendChild(tileButton);
        }
      }

      async function loadLevel(roundId) {
        console.log("→ Загрузка уровня", roundId);
        const round = gameData.find((r) => r.round_id === roundId);
        if (!round) {
          messageDiv.textContent = "Поздравляем! Вы прошли все уровни!";
          return;
        }

        currentRound = roundId;
        currentGrid = round.grid;
        levelSpan.textContent = roundId;

        numbers = [];
        for (let row = 0; row < GRID_SIZE; row++) {
          for (let col = 0; col < GRID_SIZE; col++) {
            const value = currentGrid[row][col];
            if (value !== null) {
              numbers.push({ value, row, col });
            }
          }
        }
        numbers.sort((a, b) => a.value - b.value);

        clearGame();
        resizeCanvas();
        console.log("✓ Уровень", roundId, "загружен и отрисован");
      }

      async function startGame(level) {
        console.log("→ Запуск уровня", level);
        hideModal(newGameModal);
        hideModal(rulesModal);
        hideModal(levelModal);
        closeStartMenu();
        if (gameContainer) {
          gameContainer.classList.remove("hidden");
        }
        await Promise.resolve(loadLevel(level));
      }

      function clearGame() {
        path = [];
        gameBlocked = false;
        errorSegmentIndex = -1;
        messageDiv.textContent = "";
        drawGrid();
      }

      function drawGrid() {
        ctx.clearRect(0, 0, canvasDisplaySize, canvasDisplaySize);

        for (let row = 0; row < GRID_SIZE; row++) {
          for (let col = 0; col < GRID_SIZE; col++) {
            const isVisited = path.some((p) => p.row === row && p.col === col);
            if (!isVisited) {
              ctx.fillStyle = "#f5f5f5";
              ctx.fillRect(
                col * cellSize,
                row * cellSize,
                cellSize,
                cellSize
              );
            }
          }
        }

        ctx.strokeStyle = "#ddd";
        ctx.lineWidth = Math.max(1, cellSize * 0.02);
        for (let i = 0; i <= GRID_SIZE; i++) {
          ctx.beginPath();
          ctx.moveTo(i * cellSize, 0);
          ctx.lineTo(i * cellSize, GRID_SIZE * cellSize);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(0, i * cellSize);
          ctx.lineTo(GRID_SIZE * cellSize, i * cellSize);
          ctx.stroke();
        }

        if (path.length > 0) {
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          const pathLineWidth = Math.max(3, cellSize * 0.08);

          if (errorSegmentIndex === -1 || errorSegmentIndex > 0) {
            ctx.strokeStyle = "#2196F3";
            ctx.lineWidth = pathLineWidth;
            ctx.beginPath();
            ctx.moveTo(
              path[0].col * cellSize + cellSize / 2,
              path[0].row * cellSize + cellSize / 2
            );
            const endIndex =
              errorSegmentIndex === -1 ? path.length : errorSegmentIndex + 1;
            for (let i = 1; i < endIndex; i++) {
              ctx.lineTo(
                path[i].col * cellSize + cellSize / 2,
                path[i].row * cellSize + cellSize / 2
              );
            }
            ctx.stroke();
          }

          if (errorSegmentIndex !== -1 && errorSegmentIndex < path.length - 1) {
            ctx.strokeStyle = "#f44336";
            ctx.lineWidth = pathLineWidth;
            ctx.beginPath();
            ctx.moveTo(
              path[errorSegmentIndex].col * cellSize + cellSize / 2,
              path[errorSegmentIndex].row * cellSize + cellSize / 2
            );
            ctx.lineTo(
              path[errorSegmentIndex + 1].col * cellSize + cellSize / 2,
              path[errorSegmentIndex + 1].row * cellSize + cellSize / 2
            );
            ctx.stroke();
          }
        }

        const fontSize = Math.max(Math.floor(cellSize * 0.45), 14);
        ctx.font = `bold ${fontSize}px Arial`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        for (let row = 0; row < GRID_SIZE; row++) {
          const rowData = currentGrid[row] || [];
          for (let col = 0; col < GRID_SIZE; col++) {
            const value = rowData[col];
            if (value !== null && value !== undefined) {
              const pathIndex = path.findIndex(
                (p) => p.row === row && p.col === col
              );
              const isInPath = pathIndex !== -1;

              let color = "#333";

              if (isInPath) {
                if (value === 1) {
                  color = "#2196F3";
                } else {
                  if (
                    errorSegmentIndex !== -1 &&
                    pathIndex === errorSegmentIndex + 1
                  ) {
                    color = "#f44336";
                  } else {
                    color = "#4CAF50";
                  }
                }
              }

              ctx.fillStyle = color;
              ctx.fillText(
                value,
                col * cellSize + cellSize / 2,
                row * cellSize + cellSize / 2
              );
            }
          }
        }
      }

      function getCellFromEvent(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const col = Math.floor(x / cellSize);
        const row = Math.floor(y / cellSize);

        if (row >= 0 && row < GRID_SIZE && col >= 0 && col < GRID_SIZE) {
          return { row, col };
        }
        return null;
      }

      function isAdjacent(cell1, cell2) {
        const rowDiff = Math.abs(cell1.row - cell2.row);
        const colDiff = Math.abs(cell1.col - cell2.col);
        return (
          (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1)
        );
      }

      function getExpectedNumber() {
        if (path.length === 0) return 1;

        let maxFound = 0;
        for (const cell of path) {
          const value = currentGrid[cell.row][cell.col];
          if (value !== null && value > maxFound) {
            maxFound = value;
          }
        }
        return maxFound + 1;
      }

      function checkVictoryCondition() {
        if (path.length !== GRID_SIZE * GRID_SIZE) {
          return false;
        }

        const numbersInPath = new Set();
        for (const p of path) {
          const val = currentGrid[p.row][p.col];
          if (val !== null) {
            numbersInPath.add(val);
          }
        }

        const missingNumbers = [];
        for (let i = 1; i <= 9; i++) {
          if (!numbersInPath.has(i)) {
            missingNumbers.push(i);
          }
        }

        if (missingNumbers.length > 0) {
          return false;
        }

        console.log("🎉 ПОБЕДА!");
        return true;
      }

      function addCellToPath(cell) {
        if (gameBlocked) return false;

        if (path.length === 0) {
          const value = currentGrid[cell.row][cell.col];
          if (value !== 1) {
            return false;
          }
        }

        if (path.length > 0) {
          const lastCell = path[path.length - 1];
          if (!isAdjacent(lastCell, cell)) {
            return false;
          }
        }

        if (path.some((p) => p.row === cell.row && p.col === cell.col)) {
          return false;
        }

        const cellValue = currentGrid[cell.row][cell.col];
        const expectedNum = getExpectedNumber();

        if (cellValue !== null) {
          if (cellValue !== expectedNum) {
            errorSegmentIndex = path.length - 1;
            path.push(cell);
            gameBlocked = true;
            messageDiv.textContent = "Ошибка! Нарушена последовательность.";
            messageDiv.style.color = "#f44336";
            drawGrid();
            return false;
          }
        }

        path.push(cell);
        drawGrid();

        const isVictory = checkVictoryCondition();

        if (isVictory) {
          gameBlocked = true;
          messageDiv.textContent = "Уровень пройден! Загружаем следующий...";
          messageDiv.style.color = "#4CAF50";

          const nextLevel = currentRound + 1;
          const normalizedNextLevel = Math.min(nextLevel, gameDataJSON.length);
          maxUnlockedLevel = Math.max(maxUnlockedLevel, normalizedNextLevel);
          progressLoaded = true;
          updateContinueButtonLabel();
          saveCurrentLevel(maxUnlockedLevel);

          setTimeout(() => {
            showInterstitialAd().finally(() => {
              loadLevel(nextLevel);
            });
          }, 1500);
          return true;
        }

        return true;
      }

      canvas.addEventListener("mousedown", (e) => {
        if (gameBlocked) return;
        const cell = getCellFromEvent(e);
        if (cell) {
          isDrawing = true;
          addCellToPath(cell);
        }
      });

      canvas.addEventListener("mousemove", (e) => {
        if (!isDrawing || gameBlocked) return;
        const cell = getCellFromEvent(e);
        if (cell) {
          addCellToPath(cell);
        }
      });

      canvas.addEventListener("mouseup", () => {
        isDrawing = false;
      });

      canvas.addEventListener("mouseleave", () => {
        isDrawing = false;
      });

      canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        if (gameBlocked) return;
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent("mousedown", {
          clientX: touch.clientX,
          clientY: touch.clientY,
        });
        canvas.dispatchEvent(mouseEvent);
      });

      canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent("mousemove", {
          clientX: touch.clientX,
          clientY: touch.clientY,
        });
        canvas.dispatchEvent(mouseEvent);
      });

      canvas.addEventListener("touchend", (e) => {
        e.preventDefault();
        isDrawing = false;
      });

      undoBtn.addEventListener("click", () => {
        if (path.length > 0) {
          path.pop();
          gameBlocked = false;
          errorSegmentIndex = -1;
          messageDiv.textContent = "";
          drawGrid();
        }

        showInterstitialAd();
      });

      clearBtn.addEventListener("click", () => {
        clearGame();
        showInterstitialAd();
      });

      if (menuToggleBtn) {
        menuToggleBtn.addEventListener("click", () => {
          openStartMenu();
        });
      }

      continueBtn.addEventListener("click", async () => {
        await initGame();
        await ensureProgressLoaded();
        await startGame(maxUnlockedLevel);
      });

      newGameBtn.addEventListener("click", () => {
        showModal(newGameModal);
      });

      cancelNewGameBtn.addEventListener("click", () => {
        hideModal(newGameModal);
      });

      confirmNewGameBtn.addEventListener("click", async () => {
        hideModal(newGameModal);
        await initGame();
        maxUnlockedLevel = 1;
        progressLoaded = true;
        updateContinueButtonLabel();
        await saveCurrentLevel(1);
        await startGame(1);
      });

      selectLevelBtn.addEventListener("click", async () => {
        await initGame();
        await ensureProgressLoaded();
        renderLevelTiles();
        showModal(levelModal);
      });

      closeLevelsBtn.addEventListener("click", () => {
        hideModal(levelModal);
      });

      rulesBtn.addEventListener("click", () => {
        showModal(rulesModal);
      });

      closeRulesBtn.addEventListener("click", () => {
        hideModal(rulesModal);
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          hideModal(newGameModal);
          hideModal(rulesModal);
          hideModal(levelModal);
          if (
            currentRound > 0 &&
            startMenu &&
            !startMenu.classList.contains("hidden")
          ) {
            closeStartMenu();
          }
        }
      });

      async function initGame() {
        if (appInitialized) {
          await ensureProgressLoaded();
          return;
        }

        if (!initPromise) {
          initPromise = (async () => {
            console.log("→ Инициализация игры...");

            console.log("→ Шаг 1: Инициализация рекламы...");
            await initAds();
            console.log("✓ Шаг 1 завершён");

            console.log("→ Шаг 2: Загрузка данных игры...");
            loadGameData();
            console.log("✓ Шаг 2 завершён");

            appInitialized = true;

            console.log("→ Шаг 3: Загрузка сохранённого прогресса...");
            await ensureProgressLoaded();

            console.log("✅ Игра готова к запуску уровней через меню!");
          })()
            .catch((error) => {
              console.error("Ошибка при инициализации игры:", error);
              throw error;
            })
            .finally(() => {
              initPromise = null;
            });
        }

        await initPromise;
      }

      resizeCanvas({ redraw: false });
      window.addEventListener("resize", () => resizeCanvas());
      window.addEventListener("orientationchange", () =>
        setTimeout(() => resizeCanvas(), 150)
      );
      initGame().catch((error) => {
        console.error(
          "Не удалось завершить инициализацию игры при старте:",
          error
        );
      });
    </script>
  </body>
</html>
