<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–õ–ò–ù–ò–ò –†–ê–ó–£–ú–ê</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      h1 {
        font-size: 48px;
        font-weight: bold;
        color: #fff;
        margin-bottom: 10px;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        letter-spacing: 4px;
      }
      #level-info {
        font-size: 18px;
        margin-bottom: 20px;
        color: #fff;
        font-weight: 500;
      }
      #game-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 520px;
      }
      #game-canvas {
        border: 2px solid #333;
        cursor: crosshair;
        touch-action: none;
        width: 100%;
        height: auto;
        max-width: 490px;
      }
      #controls {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
      }
      button {
        padding: 12px 20px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        color: white;
        transition: all 0.3s;
        font-weight: 500;
        width: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      #undo-btn {
        background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
      }
      #undo-btn:hover {
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transform: translateY(-2px);
      }
      #clear-btn {
        background: linear-gradient(135deg, #ec407a 0%, #e91e63 100%);
      }
      #clear-btn:hover {
        background: linear-gradient(135deg, #e91e63 0%, #d81b60 100%);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transform: translateY(-2px);
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }
      #message {
        margin-top: 15px;
        font-size: 18px;
        font-weight: bold;
        color: #4caf50;
        min-height: 25px;
      }
      #rules {
        margin-top: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
        width: 100%;
        max-width: 490px;
        font-size: 14px;
        line-height: 1.6;
        color: #333;
      }
      #rules h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #667eea;
        font-size: 16px;
      }
      #rules ul {
        margin: 5px 0;
        padding-left: 20px;
      }
      #rules li {
        margin-bottom: 5px;
      }
      #rules p {
        margin: 8px 0;
      }
      @media (max-width: 600px) {
        body {
          padding: 16px 12px 32px;
        }
        h1 {
          font-size: 34px;
          letter-spacing: 2px;
          text-align: center;
        }
        #level-info {
          font-size: 16px;
          text-align: center;
        }
        #game-container {
          padding: 16px;
        }
        #rules {
          font-size: 13px;
        }
        button {
          font-size: 15px;
        }
      }
    </style>
  </head>
  <body>
    <h1>–õ–ò–ù–ò–ò –†–ê–ó–£–ú–ê</h1>
    <div id="level-info">–£—Ä–æ–≤–µ–Ω—å: <span id="current-level">1</span></div>
    <div id="game-container">
      <canvas id="game-canvas" width="490" height="490"></canvas>
      <div id="controls">
        <button id="undo-btn">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ</button>
        <button id="clear-btn">–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ</button>
      </div>
      <div id="message"></div>
      <div id="rules">
        <h3>üìã –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã:</h3>
        <ul>
          <li>–ù–∞—á–Ω–∏—Ç–µ —Å –∫–ª–µ—Ç–∫–∏ —Å —Ü–∏—Ñ—Ä–æ–π <strong>1</strong></li>
          <li>
            –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –ª–∏–Ω–∏—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Ü–∏—Ñ—Ä—ã
            <strong>1‚Üí2‚Üí3‚Üí...‚Üí9</strong>
          </li>
          <li>–õ–∏–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç—å <strong>–≤—Å–µ 49 –∫–ª–µ—Ç–æ–∫</strong> –ø–æ–ª—è</li>
          <li>
            –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞ <strong>—Å–æ—Å–µ–¥–Ω–∏–µ –∫–ª–µ—Ç–∫–∏</strong> (–≤–≤–µ—Ä—Ö, –≤–Ω–∏–∑,
            –≤–ª–µ–≤–æ, –≤–ø—Ä–∞–≤–æ)
          </li>
          <li>–ù–µ–ª—å–∑—è –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –¥–≤–∞–∂–¥—ã —á–µ—Ä–µ–∑ –æ–¥–Ω—É –∫–ª–µ—Ç–∫—É</li>
        </ul>
        <p>
          <strong>üí° –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> –†–∏—Å—É–π—Ç–µ –ª–∏–Ω–∏—é –º—ã—à—å—é –∏–ª–∏ –ø–∞–ª—å—Ü–µ–º,
          —É–¥–µ—Ä–∂–∏–≤–∞—è –∫–Ω–æ–ø–∫—É –Ω–∞–∂–∞—Ç–æ–π. –ö—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è –æ–∑–Ω–∞—á–∞–µ—Ç –æ—à–∏–±–∫—É!
        </p>
      </div>
    </div>

    <script>
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞
      console.log("‚úì –°–∫—Ä–∏–ø—Ç –∏–≥—Ä—ã –Ω–∞—á–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ");

      // –î–∞–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω–µ–π (100 —É—Ä–æ–≤–Ω–µ–π)
      const gameDataJSON = [
        {
          round_id: 1,
          grid: [
            [1, null, null, null, null, null, 2],
            [null, 4, null, 3, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 9, 8, 7, null, 6],
            [null, null, null, null, null, null, null],
            [null, null, 5, null, null, null, null],
          ],
        },
        {
          round_id: 2,
          grid: [
            [1, null, null, null, null, null, null],
            [null, null, null, null, 8, null, 6],
            [null, null, null, 9, null, 7, null],
            [null, null, null, 5, null, null, null],
            [null, null, null, null, 3, null, 4],
            [null, null, null, null, null, null, 2],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 3,
          grid: [
            [1, null, null, null, null, null, 2],
            [null, null, null, null, null, 6, null],
            [null, null, 7, null, null, null, 3],
            [null, null, null, null, null, 8, null],
            [null, null, null, null, null, null, null],
            [null, 9, null, null, null, null, null],
            [5, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 4,
          grid: [
            [null, 8, null, 7, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 6, null, 5, null],
            [null, null, null, null, null, null, 4],
            [null, 9, null, 3, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 2, null, 1, null, null],
          ],
        },
        {
          round_id: 5,
          grid: [
            [null, null, null, null, null, null, null],
            [5, null, null, null, null, 4, null],
            [null, null, null, 8, 3, null, null],
            [null, null, null, null, null, null, 2],
            [null, null, null, 9, 1, null, null],
            [null, null, null, 7, null, null, null],
            [null, 6, null, null, null, null, null],
          ],
        },
        {
          round_id: 6,
          grid: [
            [null, 6, null, null, null, null, null],
            [null, null, 7, 8, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [5, null, null, 9, null, 3, null],
            [4, null, null, null, null, null, 2],
            [null, null, null, null, null, null, 1],
          ],
        },
        {
          round_id: 7,
          grid: [
            [null, null, null, null, null, null, null],
            [9, null, null, null, null, 8, 7],
            [1, null, null, null, 6, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 5, null, null, null, null],
            [null, 4, null, null, null, null, null],
            [null, null, 2, 3, null, null, null],
          ],
        },
        {
          round_id: 8,
          grid: [
            [null, null, 9, null, null, null, null],
            [null, null, 8, null, null, null, null],
            [null, null, null, 7, null, null, null],
            [null, null, null, null, null, 3, null],
            [null, 6, null, null, null, null, null],
            [4, null, null, null, 5, null, 2],
            [null, null, null, null, null, null, 1],
          ],
        },
        {
          round_id: 9,
          grid: [
            [null, null, 3, 2, null, null, null],
            [4, null, null, null, null, null, null],
            [null, null, 6, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [null, null, null, null, null, null, 1],
            [5, null, null, 7, null, null, null],
            [null, null, null, null, null, 9, null],
          ],
        },
        {
          round_id: 10,
          grid: [
            [null, null, null, null, 3, null, null],
            [2, 8, 7, null, null, null, null],
            [1, null, null, null, null, null, null],
            [null, null, null, null, null, 6, null],
            [null, null, 9, null, null, null, null],
            [5, null, null, null, null, null, 4],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 11,
          grid: [
            [null, null, null, null, null, 4, null],
            [null, null, 6, null, null, null, null],
            [null, null, null, 7, null, null, null],
            [3, null, null, null, 8, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 2, null, 9, null, null],
            [null, null, 1, null, null, 5, null],
          ],
        },
        {
          round_id: 12,
          grid: [
            [null, null, 1, null, null, null, 8],
            [null, 7, null, null, null, 9, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 5, null, 6, null, null],
            [null, null, null, null, 4, null, null],
            [null, null, 2, null, 3, null, null],
          ],
        },
        {
          round_id: 13,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, 8, null, null, null],
            [null, null, null, null, null, null, 7],
            [null, null, null, null, null, 1, null],
            [9, null, null, null, 6, null, null],
            [null, null, null, 4, null, 5, null],
            [null, null, 3, null, 2, null, null],
          ],
        },
        {
          round_id: 14,
          grid: [
            [null, null, null, null, null, 2, null],
            [null, null, null, null, 7, null, null],
            [1, null, null, null, null, null, null],
            [5, null, null, null, null, null, 3],
            [null, null, 6, null, 9, null, null],
            [null, null, null, null, null, 8, null],
            [null, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 15,
          grid: [
            [null, null, 8, null, null, null, null],
            [null, 2, null, null, null, null, null],
            [null, null, null, null, 7, null, null],
            [null, null, null, null, null, 5, null],
            [null, null, null, null, 6, null, null],
            [null, null, null, 9, null, null, null],
            [1, null, 3, null, 4, null, null],
          ],
        },
        {
          round_id: 16,
          grid: [
            [1, null, null, null, null, null, 5],
            [null, 4, null, 9, null, null, 6],
            [null, null, null, null, null, 7, null],
            [null, null, 8, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 3, null],
            [null, null, 2, null, null, null, null],
          ],
        },
        {
          round_id: 17,
          grid: [
            [null, null, null, null, null, 3, 4],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [2, null, null, 7, null, 6, null],
            [null, 8, null, null, 1, 5, null],
            [null, 9, null, null, null, null, null],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 18,
          grid: [
            [2, null, null, null, null, null, null],
            [null, null, null, 7, null, null, null],
            [3, 6, null, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [null, 5, null, null, null, null, 1],
            [null, null, null, null, null, null, null],
            [null, 4, null, null, 9, null, null],
          ],
        },
        {
          round_id: 19,
          grid: [
            [null, null, null, null, 9, null, null],
            [3, null, null, null, null, null, null],
            [null, null, null, null, 5, null, 8],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [2, 1, 4, null, 6, null, null],
            [null, null, null, null, null, null, 7],
          ],
        },
        {
          round_id: 20,
          grid: [
            [null, null, null, null, null, 6, 7],
            [null, null, null, null, null, null, null],
            [null, null, null, 9, null, null, 1],
            [null, null, null, null, null, 8, null],
            [5, null, null, 4, null, null, null],
            [null, null, null, null, 3, null, null],
            [null, 2, null, null, null, null, null],
          ],
        },
        {
          round_id: 21,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, 8],
            [null, 4, 9, null, null, null, null],
            [null, null, null, 5, 6, 7, null],
            [3, null, null, null, null, null, null],
            [null, null, null, null, 2, null, null],
            [null, null, null, null, null, null, 1],
          ],
        },
        {
          round_id: 22,
          grid: [
            [3, null, null, null, null, 7, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [null, null, null, 9, null, null, 6],
            [2, 4, null, null, null, null, null],
            [null, 1, null, null, 5, null, null],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 23,
          grid: [
            [null, null, null, null, null, 3, null],
            [null, null, null, null, 4, 5, null],
            [null, null, 9, null, null, null, null],
            [null, null, 8, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 7, null, null, 1, null],
            [null, null, 6, null, null, 2, null],
          ],
        },
        {
          round_id: 24,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, null, 8, 1, null],
            [null, 6, null, null, null, null, null],
            [5, null, 7, null, null, null, 2],
            [null, null, null, 9, null, null, null],
            [null, null, null, null, null, null, null],
            [4, null, null, 3, null, null, null],
          ],
        },
        {
          round_id: 25,
          grid: [
            [3, null, null, null, null, null, 4],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, 9],
            [null, null, null, 8, null, null, null],
            [null, null, 7, null, null, null, 1],
            [null, null, null, 5, null, 6, null],
            [2, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 26,
          grid: [
            [null, null, null, null, null, null, 8],
            [null, 6, null, null, null, null, 9],
            [null, null, null, null, 7, null, null],
            [null, 5, null, null, null, null, null],
            [null, null, null, null, 4, null, null],
            [null, null, null, null, null, null, null],
            [3, null, 2, null, 1, null, null],
          ],
        },
        {
          round_id: 27,
          grid: [
            [3, 2, null, null, 7, null, null],
            [null, null, null, 1, null, null, 6],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, 8, null, null, 9, null, null],
            [4, null, null, 5, null, null, null],
          ],
        },
        {
          round_id: 28,
          grid: [
            [null, null, null, 7, null, null, null],
            [null, null, null, null, null, 3, null],
            [null, null, null, null, null, null, null],
            [null, null, 9, null, null, null, 2],
            [6, null, null, 8, null, 4, null],
            [5, null, null, null, null, null, null],
            [null, null, null, null, null, null, 1],
          ],
        },
        {
          round_id: 29,
          grid: [
            [null, null, null, null, 9, null, null],
            [null, 1, null, null, null, null, null],
            [2, null, null, null, 8, null, null],
            [null, null, null, null, null, 7, null],
            [3, null, null, 5, 6, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 30,
          grid: [
            [null, null, 6, null, null, null, null],
            [null, 7, null, 8, null, null, 3],
            [null, null, null, null, 5, null, null],
            [null, null, 9, null, null, null, null],
            [null, null, null, null, 4, null, null],
            [null, 1, null, null, null, null, null],
            [null, null, 2, null, null, null, null],
          ],
        },
        {
          round_id: 31,
          grid: [
            [5, null, null, null, null, 3, null],
            [null, null, null, null, null, null, null],
            [6, null, 9, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 4, null, null],
            [null, 8, null, null, null, null, null],
            [null, 7, null, null, 1, null, 2],
          ],
        },
        {
          round_id: 32,
          grid: [
            [null, null, null, 2, 3, 4, null],
            [null, 1, null, 5, null, null, null],
            [null, null, null, null, null, 6, null],
            [null, null, null, null, null, null, null],
            [null, 8, null, null, null, null, null],
            [null, null, null, null, null, 9, null],
            [7, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 33,
          grid: [
            [null, null, 9, null, null, 7, 6],
            [null, null, null, null, null, null, null],
            [null, null, 2, null, null, null, null],
            [null, null, 3, null, null, 8, 5],
            [null, null, null, null, null, null, null],
            [null, 1, null, null, null, null, null],
            [null, null, null, null, null, 4, null],
          ],
        },
        {
          round_id: 34,
          grid: [
            [6, null, null, null, null, 5, 1],
            [null, null, null, null, null, null, null],
            [null, null, 9, null, 8, null, null],
            [null, null, null, null, null, null, null],
            [null, 7, null, null, null, null, null],
            [null, null, 3, null, null, 4, null],
            [null, null, 2, null, null, null, null],
          ],
        },
        {
          round_id: 35,
          grid: [
            [null, null, null, null, null, null, 3],
            [2, null, 8, 9, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 7, null],
            [null, 6, null, null, null, null, null],
            [null, null, null, 5, null, null, 4],
            [null, null, null, null, 1, null, null],
          ],
        },
        {
          round_id: 36,
          grid: [
            [null, null, 6, null, null, null, null],
            [null, 1, null, null, null, 7, null],
            [null, 2, null, null, 8, null, null],
            [3, null, null, null, null, null, null],
            [null, null, null, null, null, null, 5],
            [null, null, 9, null, null, null, null],
            [null, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 37,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, null, 3, null, null],
            [null, null, 8, null, null, 4, 2],
            [null, null, null, 7, 5, 1, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 6, null, null, null],
            [null, 9, null, null, null, null, null],
          ],
        },
        {
          round_id: 38,
          grid: [
            [null, null, 3, null, null, null, 2],
            [null, 4, null, null, null, 1, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 9, null, null, null],
            [8, null, null, null, null, null, 5],
            [null, null, null, null, null, null, null],
            [7, null, null, null, null, null, 6],
          ],
        },
        {
          round_id: 39,
          grid: [
            [null, null, 1, null, 2, null, null],
            [null, 6, null, null, null, null, null],
            [5, null, 8, null, 9, null, null],
            [null, null, null, null, null, null, null],
            [4, null, null, null, null, null, null],
            [null, null, null, null, null, 7, null],
            [null, null, null, null, 3, null, null],
          ],
        },
        {
          round_id: 40,
          grid: [
            [1, null, null, null, null, null, null],
            [null, null, null, 9, null, null, null],
            [null, 7, null, null, 8, null, null],
            [2, null, null, null, 6, null, 4],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 5, null],
            [null, 3, null, null, null, null, null],
          ],
        },
        {
          round_id: 41,
          grid: [
            [null, 2, null, null, 3, null, null],
            [null, 1, 4, null, null, null, null],
            [null, null, null, 6, null, null, null],
            [null, null, null, 5, null, null, 9],
            [null, null, null, null, null, null, null],
            [null, null, null, 8, null, null, null],
            [7, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 42,
          grid: [
            [9, null, null, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 5, 6, 7, null],
            [null, null, null, null, null, null, 1],
            [null, null, 4, null, null, 3, null],
            [null, null, null, null, null, 2, null],
          ],
        },
        {
          round_id: 43,
          grid: [
            [null, null, 1, null, null, null, null],
            [null, null, 4, null, null, 3, null],
            [null, null, 6, null, null, null, null],
            [null, null, null, null, 9, null, null],
            [null, null, null, null, 8, null, null],
            [null, null, null, null, null, null, null],
            [null, 5, null, 7, null, null, 2],
          ],
        },
        {
          round_id: 44,
          grid: [
            [null, null, null, null, 4, null, 5],
            [3, null, null, null, null, null, null],
            [null, null, 1, null, null, null, null],
            [null, null, null, 7, 8, 9, null],
            [null, null, null, null, null, null, null],
            [2, null, null, null, null, null, null],
            [null, null, null, null, 6, null, null],
          ],
        },
        {
          round_id: 45,
          grid: [
            [null, null, null, null, null, null, null],
            [2, null, null, null, null, null, 9],
            [null, null, null, 5, null, null, null],
            [null, null, null, null, null, 8, null],
            [null, null, 4, null, 7, null, null],
            [null, 3, null, null, null, null, null],
            [1, null, null, null, null, null, 6],
          ],
        },
        {
          round_id: 46,
          grid: [
            [null, null, 1, null, null, null, 2],
            [null, 9, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, 8, 6, 5, null, 3, null],
            [null, null, 7, null, null, null, null],
            [null, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 47,
          grid: [
            [null, null, 1, 2, null, null, null],
            [null, null, null, null, null, null, 3],
            [4, null, null, null, null, null, 5],
            [null, 7, null, null, 6, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 9, null, 8, null, null],
          ],
        },
        {
          round_id: 48,
          grid: [
            [null, null, null, null, null, 5, 1],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, 2],
            [null, null, null, null, 9, null, null],
            [null, null, null, null, null, null, 3],
            [null, 6, null, 7, null, 8, null],
            [null, 4, null, null, null, null, null],
          ],
        },
        {
          round_id: 49,
          grid: [
            [null, null, 9, null, null, null, null],
            [null, null, 8, null, null, null, 7],
            [1, 6, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 5, null, null],
            [2, null, null, null, null, null, 4],
            [null, null, null, 3, null, null, null],
          ],
        },
        {
          round_id: 50,
          grid: [
            [null, null, null, null, null, 3, null],
            [2, null, null, null, null, null, null],
            [null, null, null, null, null, null, 4],
            [null, 6, null, null, null, null, null],
            [1, null, null, 7, null, 5, null],
            [null, null, null, null, null, null, null],
            [9, null, null, null, 8, null, null],
          ],
        },
        {
          round_id: 51,
          grid: [
            [1, null, null, null, null, null, null],
            [null, 3, null, null, null, null, null],
            [null, null, null, null, null, 9, 4],
            [null, null, null, null, null, null, null],
            [2, null, 6, null, 8, null, null],
            [null, null, null, null, 7, null, null],
            [null, null, null, null, 5, null, null],
          ],
        },
        {
          round_id: 52,
          grid: [
            [null, 2, null, null, null, null, 6],
            [null, null, null, null, null, 9, null],
            [null, null, null, null, null, null, null],
            [null, null, 7, null, null, null, null],
            [1, null, null, 8, null, null, null],
            [4, 3, null, null, null, null, 5],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 53,
          grid: [
            [null, null, null, null, 5, null, null],
            [null, 1, null, 3, null, null, null],
            [2, null, null, null, 4, null, null],
            [7, null, 6, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 8, null, null, null],
            [null, null, null, null, null, null, 9],
          ],
        },
        {
          round_id: 54,
          grid: [
            [null, null, 1, 7, null, null, null],
            [null, null, null, 6, null, null, null],
            [2, 3, null, null, null, null, null],
            [null, null, null, null, null, 9, null],
            [null, null, null, null, null, null, null],
            [null, null, 4, 5, null, null, null],
            [null, null, null, null, null, null, 8],
          ],
        },
        {
          round_id: 55,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, 9, null, null, 8, null],
            [6, null, null, 7, null, null, null],
            [null, null, null, null, null, 5, null],
            [null, null, null, 4, null, null, null],
            [null, 1, 2, null, null, null, null],
            [null, null, null, null, 3, null, null],
          ],
        },
        {
          round_id: 56,
          grid: [
            [4, null, null, 5, null, null, null],
            [null, null, null, null, null, 7, null],
            [null, null, null, null, 8, 6, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [3, null, 9, null, null, 1, null],
            [2, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 57,
          grid: [
            [5, null, null, null, null, null, null],
            [null, null, null, null, null, 2, null],
            [null, null, null, null, 1, null, null],
            [null, null, null, 4, null, null, null],
            [6, null, null, null, null, 3, null],
            [null, null, null, null, 8, null, null],
            [null, null, 7, null, 9, null, null],
          ],
        },
        {
          round_id: 58,
          grid: [
            [1, null, null, null, null, null, null],
            [null, null, null, 6, null, null, null],
            [null, null, 7, null, null, null, null],
            [null, null, null, null, null, null, null],
            [8, null, null, null, null, null, null],
            [null, null, null, 5, null, 3, null],
            [9, null, null, null, 4, null, 2],
          ],
        },
        {
          round_id: 59,
          grid: [
            [null, null, null, null, 2, null, 3],
            [null, 1, null, null, null, null, null],
            [null, null, null, null, 6, null, null],
            [null, null, null, null, null, 9, null],
            [4, null, null, null, null, null, null],
            [null, null, null, null, null, 8, null],
            [null, null, 5, null, 7, null, null],
          ],
        },
        {
          round_id: 60,
          grid: [
            [null, 3, null, null, null, null, null],
            [null, null, null, null, null, null, 4],
            [null, null, null, null, 5, null, null],
            [null, 6, null, null, null, null, null],
            [null, null, null, null, null, null, 7],
            [2, null, null, 9, null, 8, null],
            [1, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 61,
          grid: [
            [5, null, null, null, 4, null, null],
            [null, 6, null, null, null, null, null],
            [null, null, null, null, null, null, 3],
            [9, null, 8, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 7, null, null, null, null],
            [null, null, null, null, 1, null, 2],
          ],
        },
        {
          round_id: 62,
          grid: [
            [null, null, null, 9, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [6, 7, null, null, 8, 4, 3],
            [null, null, null, null, null, null, null],
            [null, null, null, 5, null, null, null],
            [1, null, null, null, 2, null, null],
          ],
        },
        {
          round_id: 63,
          grid: [
            [3, null, null, null, null, 2, null],
            [null, null, null, null, null, 1, null],
            [null, null, 4, null, null, 7, null],
            [5, null, null, 8, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 9, null, null, null],
            [null, null, null, null, null, 6, null],
          ],
        },
        {
          round_id: 64,
          grid: [
            [null, null, 4, null, null, null, null],
            [null, null, null, 3, null, null, null],
            [null, null, null, null, null, null, 2],
            [null, 5, null, null, null, null, null],
            [null, null, null, null, 1, null, null],
            [6, null, null, null, null, 9, null],
            [null, null, null, 7, null, 8, null],
          ],
        },
        {
          round_id: 65,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, 8, null, null, null, null],
            [null, null, 9, null, null, null, 3],
            [null, null, null, null, null, null, 2],
            [7, 6, null, null, null, null, null],
            [null, null, null, null, 4, 1, null],
            [5, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 66,
          grid: [
            [null, null, null, null, 2, null, null],
            [null, 1, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [3, 6, null, 5, null, null, null],
            [null, null, 8, null, null, null, null],
            [null, 7, null, null, null, 9, null],
            [null, 4, null, null, null, null, null],
          ],
        },
        {
          round_id: 67,
          grid: [
            [null, null, null, null, 4, null, null],
            [null, 2, null, null, null, null, null],
            [null, null, null, null, 5, null, null],
            [null, null, 3, null, null, 6, null],
            [1, null, null, null, 7, null, null],
            [null, null, null, null, null, 8, null],
            [null, null, 9, null, null, null, null],
          ],
        },
        {
          round_id: 68,
          grid: [
            [null, 7, null, null, null, null, null],
            [null, null, 9, null, null, 1, null],
            [null, null, null, null, null, 2, null],
            [null, null, null, null, 3, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 8, null, null, null],
            [6, null, null, 5, 4, null, null],
          ],
        },
        {
          round_id: 69,
          grid: [
            [null, null, 2, null, 1, null, null],
            [null, 7, null, null, null, null, null],
            [null, null, null, null, null, null, 6],
            [null, 8, null, null, null, 9, null],
            [3, null, 5, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 4, null, null],
          ],
        },
        {
          round_id: 70,
          grid: [
            [null, null, null, 2, null, null, 3],
            [null, null, null, null, null, null, null],
            [9, null, 1, null, null, null, null],
            [null, null, null, 5, null, null, null],
            [null, null, null, 6, null, null, null],
            [null, null, null, null, null, 4, null],
            [8, null, null, null, 7, null, null],
          ],
        },
        {
          round_id: 71,
          grid: [
            [null, null, null, null, null, null, null],
            [2, null, null, null, 9, null, null],
            [null, null, 6, 8, null, null, 7],
            [null, null, 5, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 4, null, null],
            [1, 3, null, null, null, null, null],
          ],
        },
        {
          round_id: 72,
          grid: [
            [2, null, null, null, null, null, null],
            [null, null, null, null, null, 3, null],
            [null, null, null, 4, null, null, null],
            [null, null, 7, null, 6, null, null],
            [null, null, null, 8, null, null, 5],
            [null, 1, null, null, null, null, null],
            [null, null, null, 9, null, null, null],
          ],
        },
        {
          round_id: 73,
          grid: [
            [9, null, null, null, 1, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 7, 8, null, null],
            [null, 6, null, null, null, null, null],
            [null, null, null, 3, 4, 5, 2],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 74,
          grid: [
            [null, null, null, null, null, null, null],
            [3, null, 8, null, null, null, 9],
            [null, null, null, null, null, null, null],
            [null, 4, null, null, null, null, null],
            [null, null, null, null, null, null, 7],
            [null, 1, null, null, 6, null, null],
            [2, null, null, null, null, 5, null],
          ],
        },
        {
          round_id: 75,
          grid: [
            [null, null, 6, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 5, null, 4, null, 7],
            [null, null, null, null, null, null, null],
            [3, null, null, null, 2, null, 8],
            [null, null, null, null, null, 9, null],
            [null, null, 1, null, null, null, null],
          ],
        },
        {
          round_id: 76,
          grid: [
            [null, 4, null, null, 3, 2, null],
            [null, null, null, 8, null, null, null],
            [null, null, null, null, null, null, null],
            [null, 9, null, null, null, null, null],
            [null, null, null, null, 1, null, null],
            [null, null, null, 7, null, null, null],
            [null, 5, null, null, 6, null, null],
          ],
        },
        {
          round_id: 77,
          grid: [
            [9, null, null, null, 5, null, null],
            [null, null, null, null, 4, null, 2],
            [null, null, null, null, 3, null, null],
            [null, null, null, null, null, null, null],
            [null, 8, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [7, null, null, 6, 1, null, null],
          ],
        },
        {
          round_id: 78,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 5, 2],
            [3, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 6, 1],
            [null, 4, null, 8, 9, null, null],
            [null, null, null, 7, null, null, null],
          ],
        },
        {
          round_id: 79,
          grid: [
            [null, null, 9, null, null, null, null],
            [null, null, null, null, null, null, null],
            [5, null, null, null, null, 8, 7],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 3, 2, null],
            [null, null, 6, null, null, 1, null],
            [null, 4, null, null, null, null, null],
          ],
        },
        {
          round_id: 80,
          grid: [
            [3, 4, null, null, 9, null, null],
            [null, 5, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 6, 7, null, 1, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [null, null, null, 2, null, null, null],
          ],
        },
        {
          round_id: 81,
          grid: [
            [null, 2, null, null, null, null, null],
            [null, null, null, null, null, null, 4],
            [null, null, null, 6, 7, null, null],
            [null, null, null, null, 8, 9, null],
            [null, null, 5, null, null, null, null],
            [null, null, null, null, null, null, null],
            [1, null, null, null, null, null, 3],
          ],
        },
        {
          round_id: 82,
          grid: [
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, 9, null, null, 6, null, 7],
            [null, null, null, null, null, 1, null],
            [null, 8, null, null, null, null, null],
            [null, 3, null, 4, null, 5, null],
            [null, null, null, null, null, null, 2],
          ],
        },
        {
          round_id: 83,
          grid: [
            [null, 9, null, null, 4, null, null],
            [8, null, null, null, null, null, null],
            [null, null, 3, null, null, null, null],
            [7, null, null, null, null, null, null],
            [null, null, 1, null, 2, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 6, null, 5, null],
          ],
        },
        {
          round_id: 84,
          grid: [
            [null, null, null, 5, null, null, null],
            [4, null, null, null, 6, null, null],
            [null, null, null, 7, null, null, null],
            [null, null, null, null, null, null, 8],
            [null, null, 9, null, 1, 2, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 3, null, null],
          ],
        },
        {
          round_id: 85,
          grid: [
            [null, null, 4, null, null, null, 1],
            [null, null, null, null, null, 3, null],
            [null, null, 7, null, null, null, null],
            [null, null, null, 9, null, null, null],
            [null, 6, null, null, null, null, null],
            [5, null, null, null, null, null, 2],
            [null, null, null, 8, null, null, null],
          ],
        },
        {
          round_id: 86,
          grid: [
            [null, null, null, null, null, null, null],
            [8, null, null, null, null, null, 6],
            [null, null, null, null, 7, null, null],
            [null, null, null, 9, null, null, null],
            [1, null, null, null, null, null, null],
            [2, null, null, null, null, null, null],
            [null, null, 3, 4, 5, null, null],
          ],
        },
        {
          round_id: 87,
          grid: [
            [5, null, null, null, null, null, null],
            [null, null, null, null, null, 6, null],
            [1, null, null, null, null, 8, null],
            [null, null, 7, null, null, null, null],
            [null, 4, null, null, null, 9, null],
            [null, null, null, null, null, null, 3],
            [null, null, 2, null, null, null, null],
          ],
        },
        {
          round_id: 88,
          grid: [
            [null, null, null, null, 1, null, 2],
            [null, 7, null, null, null, null, null],
            [8, null, null, null, 3, null, 4],
            [null, null, null, 6, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [9, null, null, null, null, null, 5],
          ],
        },
        {
          round_id: 89,
          grid: [
            [null, null, null, null, 7, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, 2, null, null],
            [null, 8, null, 1, null, 6, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, 5, null],
            [null, null, 9, null, 3, null, 4],
          ],
        },
        {
          round_id: 90,
          grid: [
            [null, null, null, null, null, null, null],
            [null, 1, null, 3, null, null, 2],
            [null, null, null, null, null, null, null],
            [null, 9, null, null, null, null, 4],
            [null, null, null, 8, null, null, null],
            [null, 7, null, null, null, null, null],
            [null, null, 6, null, null, null, 5],
          ],
        },
        {
          round_id: 91,
          grid: [
            [null, 4, null, null, null, null, null],
            [3, null, null, null, null, null, 7],
            [null, null, null, 9, 8, null, null],
            [2, null, null, null, null, null, null],
            [null, null, 5, null, null, null, null],
            [null, 1, null, null, null, null, null],
            [null, null, 6, null, null, null, null],
          ],
        },
        {
          round_id: 92,
          grid: [
            [null, null, 4, 5, null, null, null],
            [null, null, null, null, null, 8, 7],
            [null, 3, null, null, null, null, null],
            [null, 2, null, null, null, null, null],
            [null, null, null, null, null, 9, null],
            [null, null, null, null, 6, null, null],
            [null, null, 1, null, null, null, null],
          ],
        },
        {
          round_id: 93,
          grid: [
            [null, null, null, null, null, 6, null],
            [null, 2, null, null, null, null, null],
            [null, null, null, null, null, null, 7],
            [null, 1, 3, 5, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 4, null, null, null, 8],
            [null, null, null, null, null, null, 9],
          ],
        },
        {
          round_id: 94,
          grid: [
            [null, null, null, null, null, null, 9],
            [null, 1, null, null, null, null, null],
            [null, 2, null, null, null, null, null],
            [null, null, null, null, 8, null, null],
            [3, 6, null, null, null, null, 7],
            [null, null, null, null, null, null, null],
            [null, 4, null, null, null, null, 5],
          ],
        },
        {
          round_id: 95,
          grid: [
            [4, null, null, null, null, 5, null],
            [null, 3, null, null, null, null, null],
            [2, null, null, null, null, 8, null],
            [null, null, null, null, null, null, null],
            [null, null, null, 9, null, 7, 6],
            [null, 1, null, null, null, null, null],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 96,
          grid: [
            [null, null, null, 3, null, null, null],
            [null, 5, null, null, 2, 1, null],
            [null, null, null, 4, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 7, null, null, null, null],
            [6, null, null, null, null, 9, null],
            [null, null, 8, null, null, null, null],
          ],
        },
        {
          round_id: 97,
          grid: [
            [null, null, null, null, 3, 4, 5],
            [null, null, 8, 7, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 2, 9, null, null, null],
            [null, 1, null, null, null, 6, null],
            [null, null, null, null, null, null, null],
          ],
        },
        {
          round_id: 98,
          grid: [
            [null, null, 9, null, null, null, null],
            [null, null, null, null, null, 8, null],
            [1, 2, null, null, null, null, 7],
            [null, null, null, null, null, 6, null],
            [null, null, null, null, 3, null, null],
            [null, null, null, null, null, 5, null],
            [null, null, null, null, null, null, 4],
          ],
        },
        {
          round_id: 99,
          grid: [
            [6, null, null, 7, 8, null, null],
            [null, null, null, 9, null, null, null],
            [null, null, null, null, null, null, null],
            [null, null, 5, null, null, null, null],
            [null, null, null, 3, 1, null, null],
            [null, null, null, null, null, null, 2],
            [null, null, 4, null, null, null, null],
          ],
        },
        {
          round_id: 100,
          grid: [
            [null, null, null, 6, null, null, null],
            [null, 9, 8, null, null, null, null],
            [null, null, null, null, null, null, 1],
            [null, null, null, null, null, null, null],
            [null, 7, null, null, null, 3, 2],
            [null, null, 5, null, null, null, null],
            [null, null, null, 4, null, null, null],
          ],
        },
      ];

      console.log(
        "‚úì –î–∞–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω—ã:",
        gameDataJSON.length,
        "—É—Ä–æ–≤–Ω–µ–π"
      );

      const canvas = document.getElementById("game-canvas");
      const ctx = canvas.getContext("2d");
      const undoBtn = document.getElementById("undo-btn");
      const clearBtn = document.getElementById("clear-btn");
      const messageDiv = document.getElementById("message");
      const levelSpan = document.getElementById("current-level");

      console.log("‚úì DOM —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã");

      const GRID_SIZE = 7;
      const MAX_CANVAS_SIZE = 490;
      const MIN_CANVAS_SIZE = 280;
      const CANVAS_SIDE_PADDING = 40;
      let canvasDisplaySize = canvas.clientWidth || canvas.width;
      let cellSize = canvasDisplaySize / GRID_SIZE;
      const AD_FORMAT = "interstitial";
      const STORAGE_KEY = "lines_of_mind_level";

      let gameData = [];
      let currentRound = 0;
      let currentGrid = [];
      let path = [];
      let isDrawing = false;
      let numbers = [];
      let gameBlocked = false;
      let errorSegmentIndex = -1;
      let adCheckIntervalId = null;

      function computeCanvasDisplaySize() {
        const container = canvas.parentElement;
        let availableWidth = MAX_CANVAS_SIZE;

        if (container) {
          const styles = window.getComputedStyle(container);
          const paddingLeft = parseFloat(styles.paddingLeft || "0");
          const paddingRight = parseFloat(styles.paddingRight || "0");
          availableWidth =
            container.clientWidth - paddingLeft - paddingRight;
        }

        if (!Number.isFinite(availableWidth) || availableWidth <= 0) {
          availableWidth = MAX_CANVAS_SIZE;
        }

        const viewportWidth = Math.min(
          window.innerWidth || MAX_CANVAS_SIZE,
          document.documentElement.clientWidth || MAX_CANVAS_SIZE
        );
        const viewportLimit = viewportWidth - CANVAS_SIDE_PADDING / 2;
        if (Number.isFinite(viewportLimit) && viewportLimit > 0) {
          availableWidth = Math.min(availableWidth, viewportLimit);
        }

        const minWidth = Math.min(MIN_CANVAS_SIZE, availableWidth);
        const clampedWidth = Math.max(
          minWidth,
          Math.min(MAX_CANVAS_SIZE, availableWidth)
        );

        return Math.round(clampedWidth);
      }

      function applyCanvasSize(displaySize) {
        canvasDisplaySize = displaySize;
        const dpr = window.devicePixelRatio || 1;
        canvas.style.width = `${displaySize}px`;
        canvas.style.height = `${displaySize}px`;
        const pixelSize = Math.round(displaySize * dpr);
        if (canvas.width !== pixelSize || canvas.height !== pixelSize) {
          canvas.width = pixelSize;
          canvas.height = pixelSize;
        }
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
        cellSize = displaySize / GRID_SIZE;
      }

      function resizeCanvas({ redraw = true } = {}) {
        const displaySize = computeCanvasDisplaySize();
        applyCanvasSize(displaySize);
        if (redraw) {
          drawGrid();
        }
      }

      function isBridgeAvailable() {
        const available =
          typeof window !== "undefined" &&
          window.vkBridge &&
          typeof window.vkBridge.send === "function";
        console.log("VK Bridge –¥–æ—Å—Ç—É–ø–µ–Ω?", available);
        return available;
      }

      async function checkNativeAds() {
        if (!isBridgeAvailable()) {
          return;
        }

        try {
          await window.vkBridge.send("VKWebAppCheckNativeAds", {
            ad_format: AD_FORMAT,
          });
        } catch (error) {
          console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å VKWebAppCheckNativeAds", error);
        }
      }

      async function showInterstitialAd() {
        if (!isBridgeAvailable()) {
          return;
        }

        try {
          const response = await window.vkBridge.send("VKWebAppShowNativeAds", {
            ad_format: AD_FORMAT,
          });

          if (!response?.result) {
            console.warn("–ü–æ–∫–∞–∑ interstitial-—Ä–µ–∫–ª–∞–º—ã –Ω–µ —É–¥–∞–ª—Å—è", response);
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ interstitial-—Ä–µ–∫–ª–∞–º—ã", error);
        }
      }

      async function loadSavedLevel() {
        if (!isBridgeAvailable()) {
          console.log("‚ö† VK Storage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º —Å —É—Ä–æ–≤–Ω—è 1");
          return 1;
        }

        try {
          const response = await Promise.race([
            window.vkBridge.send("VKWebAppStorageGet", {
              keys: [STORAGE_KEY],
            }),
            new Promise((_, reject) =>
              setTimeout(() => reject(new Error("Timeout")), 2000)
            ),
          ]);

          if (response.keys && response.keys.length > 0) {
            const savedLevel = parseInt(response.keys[0].value, 10);
            if (!isNaN(savedLevel) && savedLevel >= 1 && savedLevel <= 100) {
              console.log("–ó–∞–≥—Ä—É–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å:", savedLevel);
              return savedLevel;
            }
          }
        } catch (error) {
          console.error(
            "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Ä–æ–≤–Ω—è –∏–∑ VK Storage (—Ç–∞–π–º–∞—É—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞):",
            error.message
          );
        }

        console.log("–ù–∞—á–∏–Ω–∞–µ–º —Å —É—Ä–æ–≤–Ω—è 1 (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –æ—à–∏–±–∫–∞)");
        return 1;
      }

      async function saveCurrentLevel(level) {
        if (!isBridgeAvailable()) {
          console.log("‚ö† VK Storage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —É—Ä–æ–≤–µ–Ω—å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
          return;
        }

        try {
          await Promise.race([
            window.vkBridge.send("VKWebAppStorageSet", {
              key: STORAGE_KEY,
              value: level.toString(),
            }),
            new Promise((_, reject) =>
              setTimeout(() => reject(new Error("Timeout")), 2000)
            ),
          ]);
          console.log("–£—Ä–æ–≤–µ–Ω—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω:", level);
        } catch (error) {
          console.error(
            "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è –≤ VK Storage (—Ç–∞–π–º–∞—É—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞):",
            error.message
          );
        }
      }

      async function initAds() {
        if (!isBridgeAvailable()) {
          console.log("‚ö† VK Bridge –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è CodeSandbox)");
          return;
        }

        try {
          await Promise.race([
            window.vkBridge.send("VKWebAppInit"),
            new Promise((_, reject) =>
              setTimeout(() => reject(new Error("Timeout")), 2000)
            ),
          ]);
        } catch (error) {
          console.error(
            "VKWebAppInit –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç:",
            error.message
          );
          return;
        }

        await checkNativeAds();

        if (adCheckIntervalId === null) {
          adCheckIntervalId = setInterval(checkNativeAds, 60_000);
        }
      }

      function loadGameData() {
        gameData = gameDataJSON;
        console.log("‚úì –ò–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –ø–∞–º—è—Ç—å");
      }

      async function loadLevel(roundId) {
        console.log("‚Üí –ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–≤–Ω—è", roundId);
        const round = gameData.find((r) => r.round_id === roundId);
        if (!round) {
          messageDiv.textContent = "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ —É—Ä–æ–≤–Ω–∏!";
          return;
        }

        currentRound = roundId;
        currentGrid = round.grid;
        levelSpan.textContent = roundId;

        numbers = [];
        for (let row = 0; row < GRID_SIZE; row++) {
          for (let col = 0; col < GRID_SIZE; col++) {
            const value = currentGrid[row][col];
            if (value !== null) {
              numbers.push({ value, row, col });
            }
          }
        }
        numbers.sort((a, b) => a.value - b.value);

        clearGame();
        resizeCanvas();
        console.log("‚úì –£—Ä–æ–≤–µ–Ω—å", roundId, "–∑–∞–≥—Ä—É–∂–µ–Ω –∏ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω");
      }

      function clearGame() {
        path = [];
        gameBlocked = false;
        errorSegmentIndex = -1;
        messageDiv.textContent = "";
        drawGrid();
      }

      function drawGrid() {
        ctx.clearRect(0, 0, canvasDisplaySize, canvasDisplaySize);

        for (let row = 0; row < GRID_SIZE; row++) {
          for (let col = 0; col < GRID_SIZE; col++) {
            const isVisited = path.some((p) => p.row === row && p.col === col);
            if (!isVisited) {
              ctx.fillStyle = "#f5f5f5";
              ctx.fillRect(
                col * cellSize,
                row * cellSize,
                cellSize,
                cellSize
              );
            }
          }
        }

        ctx.strokeStyle = "#ddd";
        ctx.lineWidth = Math.max(1, cellSize * 0.02);
        for (let i = 0; i <= GRID_SIZE; i++) {
          ctx.beginPath();
          ctx.moveTo(i * cellSize, 0);
          ctx.lineTo(i * cellSize, GRID_SIZE * cellSize);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(0, i * cellSize);
          ctx.lineTo(GRID_SIZE * cellSize, i * cellSize);
          ctx.stroke();
        }

        if (path.length > 0) {
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          const pathLineWidth = Math.max(3, cellSize * 0.08);

          if (errorSegmentIndex === -1 || errorSegmentIndex > 0) {
            ctx.strokeStyle = "#2196F3";
            ctx.lineWidth = pathLineWidth;
            ctx.beginPath();
            ctx.moveTo(
              path[0].col * cellSize + cellSize / 2,
              path[0].row * cellSize + cellSize / 2
            );
            const endIndex =
              errorSegmentIndex === -1 ? path.length : errorSegmentIndex + 1;
            for (let i = 1; i < endIndex; i++) {
              ctx.lineTo(
                path[i].col * cellSize + cellSize / 2,
                path[i].row * cellSize + cellSize / 2
              );
            }
            ctx.stroke();
          }

          if (errorSegmentIndex !== -1 && errorSegmentIndex < path.length - 1) {
            ctx.strokeStyle = "#f44336";
            ctx.lineWidth = pathLineWidth;
            ctx.beginPath();
            ctx.moveTo(
              path[errorSegmentIndex].col * cellSize + cellSize / 2,
              path[errorSegmentIndex].row * cellSize + cellSize / 2
            );
            ctx.lineTo(
              path[errorSegmentIndex + 1].col * cellSize + cellSize / 2,
              path[errorSegmentIndex + 1].row * cellSize + cellSize / 2
            );
            ctx.stroke();
          }
        }

        const fontSize = Math.max(Math.floor(cellSize * 0.45), 14);
        ctx.font = `bold ${fontSize}px Arial`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        for (let row = 0; row < GRID_SIZE; row++) {
          const rowData = currentGrid[row] || [];
          for (let col = 0; col < GRID_SIZE; col++) {
            const value = rowData[col];
            if (value !== null && value !== undefined) {
              const pathIndex = path.findIndex(
                (p) => p.row === row && p.col === col
              );
              const isInPath = pathIndex !== -1;

              let color = "#333";

              if (isInPath) {
                if (value === 1) {
                  color = "#2196F3";
                } else {
                  if (
                    errorSegmentIndex !== -1 &&
                    pathIndex === errorSegmentIndex + 1
                  ) {
                    color = "#f44336";
                  } else {
                    color = "#4CAF50";
                  }
                }
              }

              ctx.fillStyle = color;
              ctx.fillText(
                value,
                col * cellSize + cellSize / 2,
                row * cellSize + cellSize / 2
              );
            }
          }
        }
      }

      function getCellFromEvent(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const col = Math.floor(x / cellSize);
        const row = Math.floor(y / cellSize);

        if (row >= 0 && row < GRID_SIZE && col >= 0 && col < GRID_SIZE) {
          return { row, col };
        }
        return null;
      }

      function isAdjacent(cell1, cell2) {
        const rowDiff = Math.abs(cell1.row - cell2.row);
        const colDiff = Math.abs(cell1.col - cell2.col);
        return (
          (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1)
        );
      }

      function getExpectedNumber() {
        if (path.length === 0) return 1;

        let maxFound = 0;
        for (const cell of path) {
          const value = currentGrid[cell.row][cell.col];
          if (value !== null && value > maxFound) {
            maxFound = value;
          }
        }
        return maxFound + 1;
      }

      function checkVictoryCondition() {
        if (path.length !== GRID_SIZE * GRID_SIZE) {
          return false;
        }

        const numbersInPath = new Set();
        for (const p of path) {
          const val = currentGrid[p.row][p.col];
          if (val !== null) {
            numbersInPath.add(val);
          }
        }

        const missingNumbers = [];
        for (let i = 1; i <= 9; i++) {
          if (!numbersInPath.has(i)) {
            missingNumbers.push(i);
          }
        }

        if (missingNumbers.length > 0) {
          return false;
        }

        console.log("üéâ –ü–û–ë–ï–î–ê!");
        return true;
      }

      function addCellToPath(cell) {
        if (gameBlocked) return false;

        if (path.length === 0) {
          const value = currentGrid[cell.row][cell.col];
          if (value !== 1) {
            return false;
          }
        }

        if (path.length > 0) {
          const lastCell = path[path.length - 1];
          if (!isAdjacent(lastCell, cell)) {
            return false;
          }
        }

        if (path.some((p) => p.row === cell.row && p.col === cell.col)) {
          return false;
        }

        const cellValue = currentGrid[cell.row][cell.col];
        const expectedNum = getExpectedNumber();

        if (cellValue !== null) {
          if (cellValue !== expectedNum) {
            errorSegmentIndex = path.length - 1;
            path.push(cell);
            gameBlocked = true;
            messageDiv.textContent = "–û—à–∏–±–∫–∞! –ù–∞—Ä—É—à–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å.";
            messageDiv.style.color = "#f44336";
            drawGrid();
            return false;
          }
        }

        path.push(cell);
        drawGrid();

        const isVictory = checkVictoryCondition();

        if (isVictory) {
          gameBlocked = true;
          messageDiv.textContent = "–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω! –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π...";
          messageDiv.style.color = "#4CAF50";

          const nextLevel = currentRound + 1;
          saveCurrentLevel(nextLevel);

          setTimeout(() => {
            showInterstitialAd().finally(() => {
              loadLevel(nextLevel);
            });
          }, 1500);
          return true;
        }

        return true;
      }

      canvas.addEventListener("mousedown", (e) => {
        if (gameBlocked) return;
        const cell = getCellFromEvent(e);
        if (cell) {
          isDrawing = true;
          addCellToPath(cell);
        }
      });

      canvas.addEventListener("mousemove", (e) => {
        if (!isDrawing || gameBlocked) return;
        const cell = getCellFromEvent(e);
        if (cell) {
          addCellToPath(cell);
        }
      });

      canvas.addEventListener("mouseup", () => {
        isDrawing = false;
      });

      canvas.addEventListener("mouseleave", () => {
        isDrawing = false;
      });

      canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        if (gameBlocked) return;
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent("mousedown", {
          clientX: touch.clientX,
          clientY: touch.clientY,
        });
        canvas.dispatchEvent(mouseEvent);
      });

      canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent("mousemove", {
          clientX: touch.clientX,
          clientY: touch.clientY,
        });
        canvas.dispatchEvent(mouseEvent);
      });

      canvas.addEventListener("touchend", (e) => {
        e.preventDefault();
        isDrawing = false;
      });

      undoBtn.addEventListener("click", () => {
        if (path.length > 0) {
          path.pop();
          gameBlocked = false;
          errorSegmentIndex = -1;
          messageDiv.textContent = "";
          drawGrid();
        }

        showInterstitialAd();
      });

      clearBtn.addEventListener("click", () => {
        clearGame();
        showInterstitialAd();
      });

      async function initGame() {
        console.log("‚Üí –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã...");

        console.log("‚Üí –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∫–ª–∞–º—ã...");
        await initAds();
        console.log("‚úì –®–∞–≥ 1 –∑–∞–≤–µ—Ä—à—ë–Ω");

        console.log("‚Üí –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã...");
        loadGameData();
        console.log("‚úì –®–∞–≥ 2 –∑–∞–≤–µ—Ä—à—ë–Ω");

        console.log("‚Üí –®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è...");
        const savedLevel = await loadSavedLevel();
        console.log("‚úì –®–∞–≥ 3 –∑–∞–≤–µ—Ä—à—ë–Ω, —É—Ä–æ–≤–µ–Ω—å:", savedLevel);

        console.log("‚Üí –®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–≤–Ω—è", savedLevel);
        await loadLevel(savedLevel);
        console.log("‚úì –®–∞–≥ 4 –∑–∞–≤–µ—Ä—à—ë–Ω");

        console.log("‚úÖ –ò–≥—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞!");
      }

      resizeCanvas({ redraw: false });
      window.addEventListener("resize", () => resizeCanvas());
      window.addEventListener("orientationchange", () =>
        setTimeout(() => resizeCanvas(), 150)
      );
      initGame();
    </script>
  </body>
</html>
